(this["webpackJsonpomnidj-app"]=this["webpackJsonpomnidj-app"]||[]).push([[0],{237:function(e,t,n){e.exports=n.p+"static/media/logo.5bd1aae7.png"},263:function(e,t,n){e.exports=n(516)},510:function(e,t){},513:function(e,t,n){},514:function(e,t,n){e.exports=n.p+"static/media/room.db4f85a4.png"},516:function(e,t,n){"use strict";n.r(t);var r=n(0),o=n.n(r),a=n(4),i=n.n(a),s=n(3),c=function(e){if(!e||"undefined"===e)return{};var t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(t))},l=function(){var e=Object(r.useState)((function(){return function(){console.log("Se apeleaza getUserInfo");var e=JSON.parse(window.localStorage.getItem("loggedInUser")),t=e?e.accessToken:null,n=t?c(t):null,r=n?n.user_claims:null;return console.log("userInfo este: ",r),{accessToken:t,claims:n,userInfo:r}}()})),t=Object(s.a)(e,2),n=t[0],o=t[1];console.log("useAuth called");return console.log("Intoarcem authState: ",n),[n,function(e){console.log("doLogin");var t=c(e).user_claims;o({accessToken:e,claims:c(e),userInfo:t});var n={accessToken:e};window.localStorage.setItem("loggedInUser",JSON.stringify(n))},function(){console.log("doLogout"),o({accessToken:null,claims:null,userInfo:null}),window.localStorage.removeItem("loggedInUser")}]},d=Object(r.createContext)(),u=function(e){var t=e.state,n=e.children;return o.a.createElement(d.Provider,{value:t},n)},m=function(){return Object(r.useContext)(d)},f=(n(128),n(78)),g=(n(270),n(259)),v=(n(129),n(35)),p=(n(130),n(79)),b=(n(28),n(7)),h=(n(131),n(82)),y=(n(276),n(126)),w=(n(63),n(26)),S=(n(83),n(25)),k=(n(182),n(123)),E=(n(112),n(37)),C=n(77),j=n(19),O=n(62),T=k.a.Text,D=function(e){var t=e.formik,n=e.label,r=Object(O.a)(e,["formik","label"]),a=(r.value,r.onChange,Object(O.a)(r,["value","onChange"])),i=t.errors[r.name],s=t.touched.hasOwnProperty(r.name);return o.a.createElement("div",{className:"py-2"},o.a.createElement(T,{strong:!0},n),o.a.createElement("div",{className:"mt-2"},o.a.createElement(E.a,Object.assign({value:t.values[r.name],onChange:function(e){console.log("new value is: ",e),t.setFieldValue(r.name,e)},onBlur:t.handleBlur},a)),i&&!0===s?o.a.createElement("div",{className:"error py-2 text-red-900"},i):null))},P=function(e){var t=e.formik,n=e.theRef,r=e.label,a=Object(O.a)(e,["formik","theRef","label"]),i=t.errors[a.name],s=t.touched.hasOwnProperty(a.name);return o.a.createElement("div",{className:"py-2"},o.a.createElement(T,{strong:!0},r),o.a.createElement("div",{className:"mt-2"},o.a.createElement(h.a,Object.assign({value:t.values[a.name],onChange:t.handleChange,onBlur:t.handleBlur},a,{ref:n||null})),i&&!0===s?o.a.createElement("div",{className:"error py-2 text-red-900"},i):null))},R=function(e){var t=e.formik,n=e.label,r=Object(O.a)(e,["formik","label"]),a=t.errors[r.name],i=t.touched.hasOwnProperty(r.name);return o.a.createElement("div",{className:"py-2"},o.a.createElement(T,{strong:!0},n),o.a.createElement("div",{className:"mt-2"},o.a.createElement(h.a.Password,Object.assign({value:t.values[r.name],onChange:t.handleChange,onBlur:t.handleBlur},r)),a&&!0===i?o.a.createElement("div",{className:"error py-2 text-red-900"},a):null))},x=E.a.Option,A=function(e){var t=e.visibility,n=e.onRegisterSuccess,a=Object(s.a)(t,2),i=a[0],c=a[1],l=Object(r.useState)(!1),d=Object(s.a)(l,2),u=d[0],f=d[1],g=m().backendServer,v=Object(r.useCallback)((function(e){e&&e.focus()}),[]),h=Object(r.useCallback)((function(e){fetch(g+"/users/register",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e.username,email:e.email,password:e.password,firstName:e.firstName,lastName:e.lastName,accountType:e.accountType})}).then((function(e){return e.json()})).then((function(e){e.error?(E(e.error),f(!1)):(f(!1),c(!1),n(e))})).catch((function(e){E(e),f(!1)}))}),[g,n,c]),y=Object(C.a)({initialValues:{username:"",password:"",email:"",confirmPassword:"",firstName:"",lastName:"",accountType:"viewer"},validationSchema:j.object({username:j.string().required("Please enter a username"),password:j.string().required("Please specify a password"),confirmPassword:j.string().required("Please type the password again"),email:j.string().email("Please enter a valid email address").required("Plese enter an email address"),firstName:j.string().required("Please enter first name"),lastName:j.string().required("Please enter last name"),accountType:j.string().oneOf(["dj","viewer"]).required("Please specify an account type")}),onSubmit:function(e,t){t.setSubmitting;h(e)},validate:function(e){var t={};return e.password!==e.confirmPassword&&(t.passwordConfirmation="Passwords do not match"),t}}),k=Object(r.useCallback)((function(){c(!1)}),[c]),E=function(e){console.log("Got error: ",e),S.a.error({content:String(e),key:"registerError",duration:2})};return Object(r.useEffect)((function(){console.log("Visibility changed: ",i),!0===i&&y.resetForm()}),[i]),o.a.createElement(w.a,{title:"Create an account to use OmniDJ",visible:i,onOk:function(){y.handleSubmit()},onCancel:k,footer:[o.a.createElement(b.a,{key:"back",onClick:k},"Return"),o.a.createElement(b.a,{key:"register",type:"primary",loading:u,onClick:function(){return y.handleSubmit()}},"Create account")],destroyOnClose:!0},o.a.createElement(p.a,null,o.a.createElement("form",{onSubmit:y.handleSubmit},o.a.createElement(P,{label:"Username",name:"username",type:"text",placeholder:"Enter a username",theRef:v,formik:y}),o.a.createElement(P,{label:"E-mail",name:"email",type:"email",placeholder:"Enter your e-mail",formik:y}),o.a.createElement(R,{label:"Password",name:"password",type:"text",placeholder:"Enter a password",onChange:y.handleChange,onBlur:y.handleBlur,value:y.values.password,formik:y}),o.a.createElement(R,{label:"Confirm Password",name:"confirmPassword",type:"text",placeholder:"Re-type the password",onChange:y.handleChange,onBlur:y.handleBlur,value:y.values.confirmPassword,formik:y}),!y.errors.confirmPassword&&y.errors.passwordConfirmation?o.a.createElement("div",{className:"error py-2 text-red-900"},y.errors.passwordConfirmation):null,o.a.createElement(P,{label:"First name",name:"firstName",type:"text",placeholder:"Enter first name",formik:y}),o.a.createElement(P,{label:"Last name",name:"lastName",type:"text",placeholder:"Enter last name",formik:y}),o.a.createElement(D,{label:"Account Type",name:"accountType",value:y.values.accountType,onChange:y.handleChange,onBlur:y.handleBlur,formik:y},o.a.createElement(x,{value:"dj"},"DJ"),o.a.createElement(x,{value:"viewer"},"Viewer")))))},I=k.a.Text,N=n(237),V=function(e){var t=e.onLogin,n=e.onLoginError,a=Object(r.useState)(""),i=Object(s.a)(a,2),c=i[0],l=i[1],d=Object(r.useState)(""),u=Object(s.a)(d,2),f=u[0],g=u[1],v=Object(r.useState)(!1),k=Object(s.a)(v,2),E=k[0],C=k[1],j=m().backendServer,O=Object(r.useRef)(),T=Object(r.useRef)();Object(r.useEffect)((function(){O.current.focus()}),[]);var D=function(e){e.preventDefault(),""!==c?""!==f?fetch(j+"/users/login",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:c,password:f})}).then((function(e){if(console.log("response is: ",e),!1===e.ok)throw"UNAUTHORIZED"===e.statusText?S.a.error("Please check username and password and try again"):w.a.error({title:"Could not login",content:"Server said: "+e.statusText}),new Error("Could not login");return e.json()})).then((function(e){if(e.error)!function(e){console.log("Got error: ",e),S.a.error({content:e.error,key:"loginerror",duration:2}),n&&n(e)}(e);else{var r=e.access_token;t(r)}})).catch((function(e){console.log("Error on json: ",e)})).catch((function(e){console.log("Error on login: ",e)})):S.a.error("Please enter a password"):S.a.error("Please enter a username")};return o.a.createElement(p.a,null,o.a.createElement(y.a,{type:"flex",justify:"center",align:"middle",className:"py-4"},o.a.createElement("div",{className:"w-20 h-5 bg-contain bg-no-repeat bg-center",style:{backgroundImage:"url(".concat(N,")")}})),o.a.createElement(y.a,{type:"flex",justify:"center",align:"middle"},o.a.createElement("form",null,o.a.createElement("div",{className:"py-2"},o.a.createElement(I,{strong:!0},"Username"),o.a.createElement("div",{className:"mt-2"},o.a.createElement(h.a,{ref:O,placeholder:"Enter a username",type:"text",name:"username",value:c,onChange:function(e){return l(e.target.value)},onPressEnter:function(){console.log("onUsernameEnter"),""===c?(S.a.error({content:"Please enter a username",key:"enterusername",duration:2}),O.current.focus()):T.current.focus()}}))),o.a.createElement("div",{className:"py-2"},o.a.createElement(I,{strong:!0},"Password"),o.a.createElement("div",{className:"mt-2"},o.a.createElement(h.a.Password,{placeholder:"Enter a password",ref:T,value:f,onChange:function(e){return g(e.target.value)},onPressEnter:D}))),o.a.createElement("div",{className:"py-2"},"Don't have an account?"," ",o.a.createElement("span",{onClick:function(){C(!0)},className:"text-blue-200 cursor-pointer select-none"},"Create one")))),o.a.createElement(y.a,{type:"flex",justify:"center",align:"middle"},o.a.createElement("div",{className:"py-5"},o.a.createElement(b.a,{onClick:D},"Login"))),o.a.createElement(A,{visibility:[E,C],onRegisterSuccess:function(e){console.log("onRegisterSuccess - params: ",e),l(e.username),g(e.password)}}))},M=(n(109),n(5)),F=n(51),L=n(260);q.sessions={},q.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||q.extension.isInstalled()}return!0};var J={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var t=window.setTimeout((function(){var t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)}),1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",(function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){var n=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){var r=new Error("NavigatorUserMediaError");r.name="You cancelled the request for permission, giving up...",n(r)}else n(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&(console.log("clearing ",t.data.id),window.clearTimeout(t.data.id))}))}};function q(e){if(!q.initDone)return e.error("Library not initialized"),{};if(!q.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(q.log("Library initialized: "+q.initDone),(e=e||{}).success="function"==typeof e.success?e.success:q.noop,e.error="function"==typeof e.error?e.error:q.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:q.noop,!e.server)return e.error("Invalid server url"),{};var t=!1,n=null,r={},o=null,a=null,i=0,s=e.server;q.isArray(s)?(q.log("Multiple servers provided ("+s.length+"), will use the first that works"),s=null,a=e.server,q.debug(a)):0===s.indexOf("ws")?(t=!0,q.log("Using WebSockets to contact Janus: "+s)):(t=!1,q.log("Using REST API to contact Janus: "+s));var c=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],l=e.iceTransportPolicy,d=e.bundlePolicy,u=!0===e.ipv6,m=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(m=!0===e.withCredentials);var f=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(f=e.max_poll_events),f<1&&(f=1);var g=null;void 0!==e.token&&null!==e.token&&(g=e.token);var v=null;void 0!==e.apisecret&&null!==e.apisecret&&(v=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var p=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(p=e.keepAlivePeriod),isNaN(p)&&(p=25e3);var b=6e4;function h(e){var t={high:9e5,medium:3e5,low:1e5};return void 0!==e&&null!==e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(b=e.longPollTimeout),isNaN(b)&&(b=6e4);var y=!1,w=null,S={},k=this,E=0,C={};function j(){if(null!=w)if(q.debug("Long poll..."),y){var t=s+"/"+w+"?rid="+(new Date).getTime();f&&(t=t+"&maxev="+f),g&&(t=t+"&token="+encodeURIComponent(g)),v&&(t=t+"&apisecret="+encodeURIComponent(v)),q.httpAPICall(t,{verb:"GET",withCredentials:m,success:O,timeout:b,error:function(t,n){if(q.error(t+":",n),++E>3)return y=!1,void e.error("Lost connection to the server (is it down?)");j()}})}else q.warn("Is the server down? (connected=false)")}function O(e,r){if(E=0,t||void 0===w||null===w||!0===r||j(),t||!q.isArray(e))if("keepalive"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){if(!(c=e.sender))return void q.warn("Missing sender...");if(!(d=S[c]))return void q.debug("This handle is not attached to this session");var o=e.candidate;q.debug("Got a trickled candidate on session "+w),q.debug(o);var a=d.webrtcStuff;a.pc&&a.remoteSdp?(q.debug("Adding remote candidate:",o),o&&!0!==o.completed?a.pc.addIceCandidate(o):a.pc.addIceCandidate(q.endOfCandidates)):(q.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),a.candidates||(a.candidates=[]),a.candidates.push(o),q.debug(a.candidates))}else{if("webrtcup"===e.janus)return q.debug("Got a webrtcup event on session "+w),q.debug(e),(c=e.sender)?(d=S[c])?void d.webrtcState(!0):void q.debug("This handle is not attached to this session"):void q.warn("Missing sender...");if("hangup"===e.janus){if(q.debug("Got a hangup event on session "+w),q.debug(e),!(c=e.sender))return void q.warn("Missing sender...");if(!(d=S[c]))return void q.debug("This handle is not attached to this session");d.webrtcState(!1,e.reason),d.hangup()}else if("detached"===e.janus){if(q.debug("Got a detached event on session "+w),q.debug(e),!(c=e.sender))return void q.warn("Missing sender...");if(!(d=S[c]))return;d.detached=!0,d.ondetached(),d.detach()}else if("media"===e.janus){if(q.debug("Got a media event on session "+w),q.debug(e),!(c=e.sender))return void q.warn("Missing sender...");if(!(d=S[c]))return void q.debug("This handle is not attached to this session");d.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){if(q.debug("Got a slowlink event on session "+w),q.debug(e),!(c=e.sender))return void q.warn("Missing sender...");if(!(d=S[c]))return void q.debug("This handle is not attached to this session");d.slowLink(e.uplink,e.lost)}else{if("error"===e.janus){var i,s;if(q.error("Ooops: "+e.error.code+" "+e.error.reason),q.debug(e),i=e.transaction)(s=C[i])&&s(e),delete C[i];return}if("event"===e.janus){var c;if(q.debug("Got a plugin event on session "+w),q.debug(e),!(c=e.sender))return void q.warn("Missing sender...");var l=e.plugindata;if(!l)return void q.warn("Missing plugindata...");q.debug("  -- Event is coming from "+c+" ("+l.plugin+")");var d,u=l.data;if(q.debug(u),!(d=S[c]))return void q.warn("This handle is not attached to this session");var m=e.jsep;m&&(q.debug("Handling SDP as well..."),q.debug(m));var f=d.onmessage;f?(q.debug("Notifying application..."),f(u,m)):q.debug("No provided notification callback")}else{if("timeout"===e.janus)return q.error("Timeout on session "+w),q.debug(e),void(t&&n.close(3504,"Gateway timeout"));q.warn("Unknown message/event  '"+e.janus+"' on session "+w),q.debug(e)}}}else q.debug("Got a success on session "+w),q.debug(e),(i=e.transaction)&&((s=C[i])&&s(e),delete C[i]);else q.debug("Got an ack on session "+w),q.debug(e),(i=e.transaction)&&((s=C[i])&&s(e),delete C[i]);else q.vdebug("Got a keepalive on session "+w);else for(var g=0;g<e.length;g++)O(e[g],!0)}function T(){if(s&&t&&y){o=setTimeout(T,p);var e={janus:"keepalive",session_id:w,transaction:q.randomString(12)};g&&(e.token=g),v&&(e.apisecret=v),n.send(JSON.stringify(e))}}function D(c){var l=q.randomString(12),d={janus:"create",transaction:l};if(c.reconnect&&(y=!1,d.janus="claim",d.session_id=w,n&&(n.onopen=null,n.onerror=null,n.onclose=null,o&&(clearTimeout(o),o=null))),g&&(d.token=g),v&&(d.apisecret=v),!s&&q.isArray(a)&&(0===(s=a[i]).indexOf("ws")?(t=!0,q.log("Server #"+(i+1)+": trying WebSockets to contact Janus ("+s+")")):(t=!1,q.log("Server #"+(i+1)+": trying REST API to contact Janus ("+s+")"))),t)for(var u in n=q.newWebSocket(s,"janus-protocol"),r={error:function(){if(q.error("Error connecting to the Janus WebSockets server... "+s),q.isArray(a)&&!c.reconnect)return++i==a.length?void c.error("Error connecting to any of the provided Janus servers: Is the server down?"):(s=null,void setTimeout((function(){D(c)}),200));c.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){C[l]=function(e){if(q.debug(e),"success"!==e.janus)return q.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);o=setTimeout(T,p),y=!0,w=e.session_id?e.session_id:e.data.id,c.reconnect?q.log("Claimed session: "+w):q.log("Created session: "+w),q.sessions[w]=k,c.success()},n.send(JSON.stringify(d))},message:function(e){O(JSON.parse(e.data))},close:function(){s&&y&&(y=!1,e.error("Lost connection to the server (is it down?)"))}})n.addEventListener(u,r[u]);else q.httpAPICall(s,{verb:"POST",withCredentials:m,body:d,success:function(e){if(q.debug(e),"success"!==e.janus)return q.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);y=!0,w=e.session_id?e.session_id:e.data.id,c.reconnect?q.log("Claimed session: "+w):q.log("Created session: "+w),q.sessions[w]=k,j(),c.success()},error:function(e,t){if(q.error(e+":",t),q.isArray(a)&&!c.reconnect)return++i==a.length?void c.error("Error connecting to any of the provided Janus servers: Is the server down?"):(s=null,void setTimeout((function(){D(c)}),200));""===t?c.error(e+": Is the server down?"):c.error(e+": "+t)}})}function P(e,r){if((r=r||{}).success="function"==typeof r.success?r.success:q.noop,r.error="function"==typeof r.error?r.error:q.noop,!y)return q.warn("Is the server down? (connected=false)"),void r.error("Is the server down? (connected=false)");var o=S[e];if(!o||!o.webrtcStuff)return q.warn("Invalid handle"),void r.error("Invalid handle");var a=r.message,i=r.jsep,c=q.randomString(12),l={janus:"message",body:a,transaction:c};if(o.token&&(l.token=o.token),v&&(l.apisecret=v),i&&(l.jsep=i),q.debug("Sending message to plugin (handle="+e+"):"),q.debug(l),t)return l.session_id=w,l.handle_id=e,C[c]=function(e){if(q.debug("Message sent!"),q.debug(e),"success"===e.janus){var t=e.plugindata;if(!t)return q.warn("Request succeeded, but missing plugindata..."),void r.success();q.log("Synchronous transaction successful ("+t.plugin+")");var n=t.data;return q.debug(n),void r.success(n)}"ack"===e.janus?r.success():e.error?(q.error("Ooops: "+e.error.code+" "+e.error.reason),r.error(e.error.code+" "+e.error.reason)):(q.error("Unknown error"),r.error("Unknown error"))},void n.send(JSON.stringify(l));q.httpAPICall(s+"/"+w+"/"+e,{verb:"POST",withCredentials:m,body:l,success:function(e){if(q.debug("Message sent!"),q.debug(e),"success"===e.janus){var t=e.plugindata;if(!t)return q.warn("Request succeeded, but missing plugindata..."),void r.success();q.log("Synchronous transaction successful ("+t.plugin+")");var n=t.data;return q.debug(n),void r.success(n)}"ack"===e.janus?r.success():e.error?(q.error("Ooops: "+e.error.code+" "+e.error.reason),r.error(e.error.code+" "+e.error.reason)):(q.error("Unknown error"),r.error("Unknown error"))},error:function(e,t){q.error(e+":",t),r.error(e+": "+t)}})}function R(e,r){if(y){var o=S[e];if(o&&o.webrtcStuff){var a={janus:"trickle",candidate:r,transaction:q.randomString(12)};if(o.token&&(a.token=o.token),v&&(a.apisecret=v),q.vdebug("Sending trickle candidate (handle="+e+"):"),q.vdebug(a),t)return a.session_id=w,a.handle_id=e,void n.send(JSON.stringify(a));q.httpAPICall(s+"/"+w+"/"+e,{verb:"POST",withCredentials:m,body:a,success:function(e){q.vdebug("Candidate sent!"),q.vdebug(e),"ack"===e.janus||q.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){q.error(e+":",t)}})}else q.warn("Invalid handle")}else q.warn("Is the server down? (connected=false)")}function x(e,t,n,r){var o=S[e];if(o&&o.webrtcStuff){var a=o.webrtcStuff,i=function(e){q.log("Received state change on data channel:",e);var t=e.target.label,n=a.dataChannel[t]?a.dataChannel[t].readyState:"null";if(q.log("State change on <"+t+"> data channel: "+n),"open"===n){if(a.dataChannel[t].pending&&a.dataChannel[t].pending.length>0){q.log("Sending pending messages on <"+t+">:",a.dataChannel[t].pending.length);var r=!0,i=!1,s=void 0;try{for(var c,l=a.dataChannel[t].pending[Symbol.iterator]();!(r=(c=l.next()).done);r=!0){var d=c.value;q.log("Sending string on data channel <"+t+">: "+d),a.dataChannel[t].send(d)}}catch(u){i=!0,s=u}finally{try{r||null==l.return||l.return()}finally{if(i)throw s}}a.dataChannel[t].pending=[]}o.ondataopen(t)}};a.dataChannel[t]=n||a.pc.createDataChannel(t,{ordered:!1}),a.dataChannel[t].onmessage=function(e){q.log("Received message on data channel:",e);var t=e.target.label;o.ondata(e.data,t)},a.dataChannel[t].onopen=i,a.dataChannel[t].onclose=i,a.dataChannel[t].onerror=function(e){q.error("Got error on data channel:",e)},a.dataChannel[t].pending=[],r&&a.dataChannel[t].pending.push(r)}else q.warn("Invalid handle")}function A(e,t){(t=t||{}).success="function"==typeof t.success?t.success:q.noop,t.error="function"==typeof t.error?t.error:q.noop;var n=S[e];if(!n||!n.webrtcStuff)return q.warn("Invalid handle"),void t.error("Invalid handle");var r=n.webrtcStuff,o=t.text;if(!o)return q.warn("Invalid text"),void t.error("Invalid text");var a=t.label?t.label:q.dataChanDefaultLabel;return r.dataChannel[a]?"open"!==r.dataChannel[a].readyState?(r.dataChannel[a].pending.push(o),void t.success()):(q.log("Sending string on data channel <"+a+">: "+o),r.dataChannel[a].send(o),void t.success()):(x(e,a,!1,o),void t.success())}function I(e,t){(t=t||{}).success="function"==typeof t.success?t.success:q.noop,t.error="function"==typeof t.error?t.error:q.noop;var n=S[e];if(!n||!n.webrtcStuff)return q.warn("Invalid handle"),void t.error("Invalid handle");var r=n.webrtcStuff;if(!r.dtmfSender){if(r.pc){var o=r.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!o)return q.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");r.dtmfSender=o.dtmf,r.dtmfSender&&(q.log("Created DTMF Sender"),r.dtmfSender.ontonechange=function(e){q.debug("Sent DTMF tone: "+e.tone)})}if(!r.dtmfSender)return q.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}var a=t.dtmf;if(!a)return q.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");var i=a.tones;if(!i)return q.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");var s="number"===typeof a.duration?a.duration:500,c="number"===typeof a.gap?a.gap:50;q.debug("Sending DTMF string "+i+" (duration "+s+"ms, gap "+c+"ms)"),r.dtmfSender.insertDTMF(i,s,c),t.success()}function N(e,r){(r=r||{}).success="function"==typeof r.success?r.success:q.noop,r.error="function"==typeof r.error?r.error:q.noop;var o=!0;void 0!==r.asyncRequest&&null!==r.asyncRequest&&(o=!0===r.asyncRequest);var a=!0;void 0!==r.noRequest&&null!==r.noRequest&&(a=!0===r.noRequest),q.log("Destroying handle "+e+" (async="+o+")"),B(e);var i=S[e];if(!i||i.detached)return delete S[e],void r.success();if(a)return delete S[e],void r.success();if(!y)return q.warn("Is the server down? (connected=false)"),void r.error("Is the server down? (connected=false)");var c={janus:"detach",transaction:q.randomString(12)};if(i.token&&(c.token=i.token),v&&(c.apisecret=v),t)return c.session_id=w,c.handle_id=e,n.send(JSON.stringify(c)),delete S[e],void r.success();q.httpAPICall(s+"/"+w+"/"+e,{verb:"POST",async:o,withCredentials:m,body:c,success:function(t){q.log("Destroyed handle:"),q.debug(t),"success"!==t.janus&&q.error("Ooops: "+t.error.code+" "+t.error.reason),delete S[e],r.success()},error:function(t,n){q.error(t+":",n),delete S[e],r.success()}})}function V(e,t,n,r,o){var a=S[e];if(!a||!a.webrtcStuff)return q.warn("Invalid handle"),void r.error("Invalid handle");var i=a.webrtcStuff;q.debug("streamsDone:",o),o&&(q.debug("  -- Audio tracks:",o.getAudioTracks()),q.debug("  -- Video tracks:",o.getVideoTracks()));var s=!1;if(i.myStream&&n.update&&!i.streamExternal){if((!n.update&&W(n)||n.update&&(n.addAudio||n.replaceAudio))&&o.getAudioTracks()&&o.getAudioTracks().length)if(i.myStream.addTrack(o.getAudioTracks()[0]),q.unifiedPlan){q.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]);var m=null;if((y=i.pc.getTransceivers())&&y.length>0){var f=!0,g=!1,v=void 0;try{for(var p,b=y[Symbol.iterator]();!(f=(p=b.next()).done);f=!0){if((T=p.value).sender&&T.sender.track&&"audio"===T.sender.track.kind||T.receiver&&T.receiver.track&&"audio"===T.receiver.track.kind){m=T;break}}}catch(N){g=!0,v=N}finally{try{f||null==b.return||b.return()}finally{if(g)throw v}}}m&&m.sender?m.sender.replaceTrack(o.getAudioTracks()[0]):i.pc.addTrack(o.getAudioTracks()[0],o)}else q.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]),i.pc.addTrack(o.getAudioTracks()[0],o);if((!n.update&&H(n)||n.update&&(n.addVideo||n.replaceVideo))&&o.getVideoTracks()&&o.getVideoTracks().length)if(i.myStream.addTrack(o.getVideoTracks()[0]),q.unifiedPlan){q.log((n.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]);var y,w=null;if((y=i.pc.getTransceivers())&&y.length>0){var k=!0,E=!1,C=void 0;try{for(var j,O=y[Symbol.iterator]();!(k=(j=O.next()).done);k=!0){var T;if((T=j.value).sender&&T.sender.track&&"video"===T.sender.track.kind||T.receiver&&T.receiver.track&&"video"===T.receiver.track.kind){w=T;break}}}catch(N){E=!0,C=N}finally{try{k||null==O.return||O.return()}finally{if(E)throw C}}}w&&w.sender?w.sender.replaceTrack(o.getVideoTracks()[0]):i.pc.addTrack(o.getVideoTracks()[0],o)}else q.log((n.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]),i.pc.addTrack(o.getVideoTracks()[0],o)}else i.myStream=o,s=!0;if(!i.pc){var D={iceServers:c,iceTransportPolicy:l,bundlePolicy:d};"chrome"===q.webRTCAdapter.browserDetails.browser&&(D.sdpSemantics=q.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var P={optional:[{DtlsSrtpKeyAgreement:!0}]};if(u&&P.optional.push({googIPv6:!0}),r.rtcConstraints&&"object"===typeof r.rtcConstraints)for(var A in q.debug("Adding custom PeerConnection constraints:",r.rtcConstraints),r.rtcConstraints)P.optional.push(r.rtcConstraints[A]);"edge"===q.webRTCAdapter.browserDetails.browser&&(D.bundlePolicy="max-bundle"),q.log("Creating PeerConnection"),q.debug(P),i.pc=new RTCPeerConnection(D,P),q.debug(i.pc),i.pc.getStats&&(i.volume={},i.bitrate.value="0 kbits/sec"),q.log("Preparing local SDP and gathering candidates (trickle="+i.trickle+")"),i.pc.oniceconnectionstatechange=function(e){i.pc&&a.iceState(i.pc.iceConnectionState)},i.pc.onicecandidate=function(t){if(!t.candidate||"edge"===q.webRTCAdapter.browserDetails.browser&&t.candidate.candidate.indexOf("endOfCandidates")>0)q.log("End of candidates."),i.iceDone=!0,!0===i.trickle?R(e,{completed:!0}):function(e,t){(t=t||{}).success="function"==typeof t.success?t.success:q.noop,t.error="function"==typeof t.error?t.error:q.noop;var n=S[e];if(!n||!n.webrtcStuff)return void q.warn("Invalid handle, not sending anything");var r=n.webrtcStuff;if(q.log("Sending offer/answer SDP..."),!r.mySdp)return void q.warn("Local SDP instance is invalid, not sending anything...");r.mySdp={type:r.pc.localDescription.type,sdp:r.pc.localDescription.sdp},!1===r.trickle&&(r.mySdp.trickle=!1);q.debug(t),r.sdpSent=!0,t.success(r.mySdp)}(e,r);else{var n={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};!0===i.trickle&&R(e,n)}},i.pc.ontrack=function(e){q.log("Handling Remote Track"),q.debug(e),e.streams&&(i.remoteStream=e.streams[0],a.onremotestream(i.remoteStream),e.track.onended||(q.log("Adding onended callback to track:",e.track),e.track.onended=function(e){q.log("Remote track muted/removed:",e),i.remoteStream&&(i.remoteStream.removeTrack(e.target),a.onremotestream(i.remoteStream))},e.track.onmute=e.track.onended,e.track.onunmute=function(e){q.log("Remote track flowing again:",e);try{i.remoteStream.addTrack(e.target),a.onremotestream(i.remoteStream)}catch(t){q.error(t)}}))}}if(s&&o){q.log("Adding local stream");var I=!0===r.simulcast2;o.getTracks().forEach((function(e){if(q.log("Adding local track:",e),I)if("audio"===e.kind)i.pc.addTrack(e,o);else{q.log("Enabling rid-based simulcasting:",e);var t=h(r.simulcastMaxBitrates);i.pc.addTransceiver(e,{direction:"sendrecv",streams:[o],sendEncodings:[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}]})}else i.pc.addTrack(e,o)}))}(function(e){if(q.debug("isDataEnabled:",e),"edge"===q.webRTCAdapter.browserDetails.browser)return q.warn("Edge doesn't support data channels yet"),!1;return void 0!==e&&null!==e&&!0===e.data})(n)&&!i.dataChannel[q.dataChanDefaultLabel]&&(q.log("Creating data channel"),x(e,q.dataChanDefaultLabel,!1),i.pc.ondatachannel=function(t){q.log("Data channel created by Janus:",t),x(e,t.channel.label,t.channel)}),i.myStream&&a.onlocalstream(i.myStream),t?i.pc.setRemoteDescription(t).then((function(){if(q.log("Remote description accepted!"),i.remoteSdp=t.sdp,i.candidates&&i.candidates.length>0){for(var o=0;o<i.candidates.length;o++){var a=i.candidates[o];q.debug("Adding remote candidate:",a),a&&!0!==a.completed?i.pc.addIceCandidate(a):i.pc.addIceCandidate(q.endOfCandidates)}i.candidates=[]}!function(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:q.noop,n.error="function"==typeof n.error?n.error:q.noop,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:q.noop;var r=S[e];if(!r||!r.webrtcStuff)return q.warn("Invalid handle"),void n.error("Invalid handle");var o=r.webrtcStuff,a=!0===n.simulcast;a?q.log("Creating answer (iceDone="+o.iceDone+", simulcast="+a+")"):q.log("Creating answer (iceDone="+o.iceDone+")");var i=null;if(q.unifiedPlan){i={};var s=null,c=null,l=o.pc.getTransceivers();if(l&&l.length>0){var d=!0,u=!1,m=void 0;try{for(var f,g=l[Symbol.iterator]();!(d=(f=g.next()).done);d=!0){var v=f.value;v.sender&&v.sender.track&&"audio"===v.sender.track.kind||v.receiver&&v.receiver.track&&"audio"===v.receiver.track.kind?s||(s=v):(v.sender&&v.sender.track&&"video"===v.sender.track.kind||v.receiver&&v.receiver.track&&"video"===v.receiver.track.kind)&&(c||(c=v))}}catch(N){u=!0,m=N}finally{try{d||null==g.return||g.return()}finally{if(u)throw m}}}var p=W(t),b=z(t);if(p||b){if(p&&b){if(s)try{s.setDirection?s.setDirection("sendrecv"):s.direction="sendrecv",q.log("Setting audio transceiver to sendrecv:",s)}catch(O){q.error(O)}}else if(p&&!b)try{s&&(s.setDirection?s.setDirection("sendonly"):s.direction="sendonly",q.log("Setting audio transceiver to sendonly:",s))}catch(O){q.error(O)}else if(!p&&b)if(s)try{s.setDirection?s.setDirection("recvonly"):s.direction="recvonly",q.log("Setting audio transceiver to recvonly:",s)}catch(O){q.error(O)}else s=o.pc.addTransceiver("audio",{direction:"recvonly"}),q.log("Adding recvonly audio transceiver:",s)}else if(t.removeAudio&&s)try{s.setDirection?s.setDirection("inactive"):s.direction="inactive",q.log("Setting audio transceiver to inactive:",s)}catch(O){q.error(O)}var y=H(t),w=K(t);if(y||w){if(y&&w){if(c)try{c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",q.log("Setting video transceiver to sendrecv:",c)}catch(O){q.error(O)}}else if(y&&!w){if(c)try{c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",q.log("Setting video transceiver to sendonly:",c)}catch(O){q.error(O)}}else if(!y&&w)if(c)try{c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",q.log("Setting video transceiver to recvonly:",c)}catch(O){q.error(O)}else c=o.pc.addTransceiver("video",{direction:"recvonly"}),q.log("Adding recvonly video transceiver:",c)}else if(t.removeVideo&&c)try{c.setDirection?c.setDirection("inactive"):c.direction="inactive",q.log("Setting video transceiver to inactive:",c)}catch(O){q.error(O)}}else i="firefox"===q.webRTCAdapter.browserDetails.browser||"edge"===q.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:z(t),offerToReceiveVideo:K(t)}:{mandatory:{OfferToReceiveAudio:z(t),OfferToReceiveVideo:K(t)}};q.debug(i);var k=H(t);if(k&&a&&"firefox"===q.webRTCAdapter.browserDetails.browser){q.log("Enabling Simulcasting for Firefox (RID)");var E=o.pc.getSenders()[1];q.log(E);var C=E.getParameters();q.log(C);var j=h(n.simulcastMaxBitrates);E.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:j.high},{rid:"medium",active:!0,priority:"medium",maxBitrate:j.medium},{rid:"low",active:!0,priority:"low",maxBitrate:j.low}]})}o.pc.createAnswer(i).then((function(e){q.debug(e);var t={type:e.type,sdp:e.sdp};n.customizeSdp(t),e.sdp=t.sdp,q.log("Setting local description"),k&&a&&("chrome"===q.webRTCAdapter.browserDetails.browser?q.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==q.webRTCAdapter.browserDetails.browser&&q.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp=e.sdp,o.pc.setLocalDescription(e).catch(n.error),o.mediaConstraints=i,o.iceDone||o.trickle?n.success(e):q.log("Waiting for all candidates...")}),n.error)}(e,n,r)}),r.error):function(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:q.noop,n.error="function"==typeof n.error?n.error:q.noop,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:q.noop;var r=S[e];if(!r||!r.webrtcStuff)return q.warn("Invalid handle"),void n.error("Invalid handle");var o=r.webrtcStuff,a=!0===n.simulcast;a?q.log("Creating offer (iceDone="+o.iceDone+", simulcast="+a+")"):q.log("Creating offer (iceDone="+o.iceDone+")");var i={};if(q.unifiedPlan){var s=null,c=null,l=o.pc.getTransceivers();if(l&&l.length>0){var d=!0,u=!1,m=void 0;try{for(var f,g=l[Symbol.iterator]();!(d=(f=g.next()).done);d=!0){var v=f.value;v.sender&&v.sender.track&&"audio"===v.sender.track.kind||v.receiver&&v.receiver.track&&"audio"===v.receiver.track.kind?s||(s=v):(v.sender&&v.sender.track&&"video"===v.sender.track.kind||v.receiver&&v.receiver.track&&"video"===v.receiver.track.kind)&&(c||(c=v))}}catch(N){u=!0,m=N}finally{try{d||null==g.return||g.return()}finally{if(u)throw m}}}var p=W(t),b=z(t);p||b?p&&b?s&&(s.setDirection?s.setDirection("sendrecv"):s.direction="sendrecv",q.log("Setting audio transceiver to sendrecv:",s)):p&&!b?s&&(s.setDirection?s.setDirection("sendonly"):s.direction="sendonly",q.log("Setting audio transceiver to sendonly:",s)):!p&&b&&(s?(s.setDirection?s.setDirection("recvonly"):s.direction="recvonly",q.log("Setting audio transceiver to recvonly:",s)):(s=o.pc.addTransceiver("audio",{direction:"recvonly"}),q.log("Adding recvonly audio transceiver:",s))):t.removeAudio&&s&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive",q.log("Setting audio transceiver to inactive:",s));var y=H(t),w=K(t);y||w?y&&w?c&&(c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",q.log("Setting video transceiver to sendrecv:",c)):y&&!w?c&&(c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",q.log("Setting video transceiver to sendonly:",c)):!y&&w&&(c?(c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",q.log("Setting video transceiver to recvonly:",c)):(c=o.pc.addTransceiver("video",{direction:"recvonly"}),q.log("Adding recvonly video transceiver:",c))):t.removeVideo&&c&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive",q.log("Setting video transceiver to inactive:",c))}else i.offerToReceiveAudio=z(t),i.offerToReceiveVideo=K(t);!0===n.iceRestart&&(i.iceRestart=!0);q.debug(i);var k=H(t);if(k&&a&&"firefox"===q.webRTCAdapter.browserDetails.browser){q.log("Enabling Simulcasting for Firefox (RID)");var E=o.pc.getSenders().find((function(e){return"video"==e.track.kind}));if(E){var C=E.getParameters();C||(C={});var j=h(n.simulcastMaxBitrates);C.encodings=[{rid:"h",active:!0,maxBitrate:j.high},{rid:"m",active:!0,maxBitrate:j.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:j.low,scaleResolutionDownBy:4}],E.setParameters(C)}}o.pc.createOffer(i).then((function(e){q.debug(e);var t={type:e.type,sdp:e.sdp};n.customizeSdp(t),e.sdp=t.sdp,q.log("Setting local description"),k&&a&&("chrome"===q.webRTCAdapter.browserDetails.browser||"safari"===q.webRTCAdapter.browserDetails.browser?(q.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){for(var t=e.split("\r\n"),n=!1,r=[-1],o=[-1],a=null,i=null,s=null,c=null,l=-1,d=0;d<t.length;d++){if(m=t[d].match(/m=(\w+) */)){if("video"===m[1]){if(!(r[0]<0)){l=d;break}n=!0}else if(r[0]>-1){l=d;break}}else if(n){var u=t[d].match(/a=ssrc-group:FID (\d+) (\d+)/);if(u)r[0]=u[1],o[0]=u[2],t.splice(d,1),d--;else{if(r[0]){if((g=t[d].match("a=ssrc:"+r[0]+" cname:(.+)"))&&(a=g[1]),(g=t[d].match("a=ssrc:"+r[0]+" msid:(.+)"))&&(i=g[1]),(g=t[d].match("a=ssrc:"+r[0]+" mslabel:(.+)"))&&(s=g[1]),(g=t[d].match("a=ssrc:"+r[0]+" label:(.+)"))&&(c=g[1]),0===t[d].indexOf("a=ssrc:"+o[0])){t.splice(d,1),d--;continue}if(0===t[d].indexOf("a=ssrc:"+r[0])){t.splice(d,1),d--;continue}}0!=t[d].length||(t.splice(d,1),d--)}}}if(r[0]<0){l=-1,n=!1;for(d=0;d<t.length;d++){var m;if(m=t[d].match(/m=(\w+) */)){if("video"===m[1]){if(!(r[0]<0)){l=d;break}n=!0}else if(r[0]>-1){l=d;break}}else if(n){if(r[0]<0){var f=t[d].match(/a=ssrc:(\d+)/);if(f){r[0]=f[1],t.splice(d,1),d--;continue}}else{var g;if((g=t[d].match("a=ssrc:"+r[0]+" cname:(.+)"))&&(a=g[1]),(g=t[d].match("a=ssrc:"+r[0]+" msid:(.+)"))&&(i=g[1]),(g=t[d].match("a=ssrc:"+r[0]+" mslabel:(.+)"))&&(s=g[1]),(g=t[d].match("a=ssrc:"+r[0]+" label:(.+)"))&&(c=g[1]),0===t[d].indexOf("a=ssrc:"+o[0])){t.splice(d,1),d--;continue}if(0===t[d].indexOf("a=ssrc:"+r[0])){t.splice(d,1),d--;continue}}0!=t[d].length||(t.splice(d,1),d--)}}}if(r[0]<0)return q.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;l<0&&(l=t.length);r[1]=Math.floor(4294967295*Math.random()),r[2]=Math.floor(4294967295*Math.random()),o[1]=Math.floor(4294967295*Math.random()),o[2]=Math.floor(4294967295*Math.random());for(d=0;d<r.length;d++)a&&(t.splice(l,0,"a=ssrc:"+r[d]+" cname:"+a),l++),i&&(t.splice(l,0,"a=ssrc:"+r[d]+" msid:"+i),l++),s&&(t.splice(l,0,"a=ssrc:"+r[d]+" mslabel:"+s),l++),c&&(t.splice(l,0,"a=ssrc:"+r[d]+" label:"+c),l++),a&&(t.splice(l,0,"a=ssrc:"+o[d]+" cname:"+a),l++),i&&(t.splice(l,0,"a=ssrc:"+o[d]+" msid:"+i),l++),s&&(t.splice(l,0,"a=ssrc:"+o[d]+" mslabel:"+s),l++),c&&(t.splice(l,0,"a=ssrc:"+o[d]+" label:"+c),l++);t.splice(l,0,"a=ssrc-group:FID "+r[2]+" "+o[2]),t.splice(l,0,"a=ssrc-group:FID "+r[1]+" "+o[1]),t.splice(l,0,"a=ssrc-group:FID "+r[0]+" "+o[0]),t.splice(l,0,"a=ssrc-group:SIM "+r[0]+" "+r[1]+" "+r[2]),(e=t.join("\r\n")).endsWith("\r\n")||(e+="\r\n");return e}(e.sdp)):"firefox"!==q.webRTCAdapter.browserDetails.browser&&q.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp=e.sdp,o.pc.setLocalDescription(e).catch(n.error),o.mediaConstraints=i,o.iceDone||o.trickle?(q.log("Offer ready"),q.debug(n),n.success(e)):q.log("Waiting for all candidates...")}),n.error)}(e,n,r)}function M(e,t,n){(n=n||{}).success="function"==typeof n.success?n.success:q.noop,n.error="function"==typeof n.error?n.error:G;var r=n.jsep;if(t&&r)return q.error("Provided a JSEP to a createOffer"),void n.error("Provided a JSEP to a createOffer");if(!t&&(!r||!r.type||!r.sdp))return q.error("A valid JSEP is required for createAnswer"),void n.error("A valid JSEP is required for createAnswer");n.media="object"===typeof n.media&&n.media?n.media:{audio:!0,video:!0};var o=n.media,a=S[e];if(!a||!a.webrtcStuff)return q.warn("Invalid handle"),void n.error("Invalid handle");var i,s=a.webrtcStuff;if(s.trickle=(i=n.trickle,q.debug("isTrickleEnabled:",i),!1!==i),s.pc){if(q.log("Updating existing media session"),o.update=!0,n.stream)n.stream!==s.myStream&&q.log("Renegotiation involves a new external stream");else{if(o.addAudio){if(o.keepAudio=!1,o.replaceAudio=!1,o.removeAudio=!1,o.audioSend=!0,s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length)return q.error("Can't add audio stream, there already is one"),void n.error("Can't add audio stream, there already is one")}else o.removeAudio?(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!1,o.audioSend=!1):o.replaceAudio&&(o.keepAudio=!1,o.addAudio=!1,o.removeAudio=!1,o.audioSend=!0);if(s.myStream?s.myStream.getAudioTracks()&&0!==s.myStream.getAudioTracks().length?!W(o)||o.removeAudio||o.replaceAudio||(o.keepAudio=!0):(o.replaceAudio&&(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),W(o)&&(o.keepVideo=!1,o.addAudio=!0)):(o.replaceAudio&&(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),W(o)&&(o.keepAudio=!1,o.addAudio=!0)),o.addVideo){if(o.keepVideo=!1,o.replaceVideo=!1,o.removeVideo=!1,o.videoSend=!0,s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length)return q.error("Can't add video stream, there already is one"),void n.error("Can't add video stream, there already is one")}else o.removeVideo?(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!1,o.videoSend=!1):o.replaceVideo&&(o.keepVideo=!1,o.addVideo=!1,o.removeVideo=!1,o.videoSend=!0);s.myStream&&s.myStream.getVideoTracks()&&0!==s.myStream.getVideoTracks().length?!H(o)||o.removeVideo||o.replaceVideo||(o.keepVideo=!0):(o.replaceVideo&&(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!0,o.videoSend=!0),H(o)&&(o.keepVideo=!1,o.addVideo=!0)),o.addData&&(o.data=!0)}if(W(o)&&o.keepAudio&&H(o)&&o.keepVideo)return a.consentDialog(!1),void V(e,r,o,n,s.myStream)}else o.update=!1,o.keepAudio=!1,o.keepVideo=!1;if(o.update&&!s.streamExternal){if(o.removeAudio||o.replaceAudio){if(s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length){var c=s.myStream.getAudioTracks()[0];q.log("Removing audio track:",c),s.myStream.removeTrack(c);try{c.stop()}catch(z){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var l=!0;if(o.replaceAudio&&q.unifiedPlan&&(l=!1),l){var d=!0,u=!1,m=void 0;try{for(var f,g=s.pc.getSenders()[Symbol.iterator]();!(d=(f=g.next()).done);d=!0){(c=f.value)&&c.track&&"audio"===c.track.kind&&(q.log("Removing audio sender:",c),s.pc.removeTrack(c))}}catch(K){u=!0,m=K}finally{try{d||null==g.return||g.return()}finally{if(u)throw m}}}}}if(o.removeVideo||o.replaceVideo){if(s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length){c=s.myStream.getVideoTracks()[0];q.log("Removing video track:",c),s.myStream.removeTrack(c);try{c.stop()}catch(z){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var v=!0;if(o.replaceVideo&&q.unifiedPlan&&(v=!1),v){var p=!0,b=!1,h=void 0;try{for(var y,w=s.pc.getSenders()[Symbol.iterator]();!(p=(y=w.next()).done);p=!0){(c=y.value)&&c.track&&"video"===c.track.kind&&(q.log("Removing video sender:",c),s.pc.removeTrack(c))}}catch(K){b=!0,h=K}finally{try{p||null==w.return||w.return()}finally{if(b)throw h}}}}}}if(n.stream){var k=n.stream;if(q.log("MediaStream provided by the application"),q.debug(k),o.update&&s.myStream&&s.myStream!==n.stream&&!s.streamExternal){try{var E=s.myStream.getTracks(),C=!0,j=!1,O=void 0;try{for(var T,D=E[Symbol.iterator]();!(C=(T=D.next()).done);C=!0){var P=T.value;q.log(P),P&&P.stop()}}catch(K){j=!0,O=K}finally{try{C||null==D.return||D.return()}finally{if(j)throw O}}}catch(z){}s.myStream=null}return s.streamExternal=!0,a.consentDialog(!1),void V(e,r,o,n,k)}if(W(o)||H(o)){if(!q.isGetUserMediaAvailable())return void n.error("getUserMedia not available");var R={mandatory:{},optional:[]};a.consentDialog(!0);var x=W(o);x&&o&&"object"===typeof o.audio&&(x=o.audio);var A=H(o);if(A&&o){var I=!0===n.simulcast,N=!0===n.simulcast2;if(!I&&!N||r||o.video||(o.video="hires"),o.video&&"screen"!=o.video&&"window"!=o.video)if("object"===typeof o.video)A=o.video;else{var M=0,F=0;"lowres"===o.video?(F=240,240,M=320):"lowres-16:9"===o.video?(F=180,180,M=320):"hires"===o.video||"hires-16:9"===o.video||"hdres"===o.video?(F=720,720,M=1280):"fhdres"===o.video?(F=1080,1080,M=1920):"4kres"===o.video?(F=2160,2160,M=3840):"stdres"===o.video?(F=480,480,M=640):"stdres-16:9"===o.video?(F=360,360,M=640):(q.log("Default video setting is stdres 4:3"),F=480,480,M=640),q.log("Adding media constraint:",o.video),A={height:{ideal:F},width:{ideal:M}},q.log("Adding video constraint:",A)}else if("screen"===o.video||"window"===o.video){var L=function(t,i){a.consentDialog(!1),t?n.error(t):V(e,r,o,n,i)},J=function(e,t,n){q.log("Adding media constraint (screen capture)"),q.debug(e),navigator.mediaDevices.getUserMedia(e).then((function(e){n?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(n){e.addTrack(n.getAudioTracks()[0]),t(null,e)})):t(null,e)})).catch((function(e){a.consentDialog(!1),t(e)}))};if(o.screenshareFrameRate||(o.screenshareFrameRate=3),navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return void navigator.mediaDevices.getDisplayMedia({video:!0,audio:o.captureDesktopAudio}).then((function(t){a.consentDialog(!1),W(o)&&!o.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(a){t.addTrack(a.getAudioTracks()[0]),V(e,r,o,n,t)})):V(e,r,o,n,t)}),(function(e){a.consentDialog(!1),n.error(e)}));if("chrome"===q.webRTCAdapter.browserDetails.browser){var _=q.webRTCAdapter.browserDetails.version,U=33;window.navigator.userAgent.match("Linux")&&(U=35),_>=26&&_<=U?(R={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate,chromeMediaSource:"screen"}},audio:W(o)&&!o.keepAudio},J(R,L)):q.extension.getScreen((function(e,t){if(e)return a.consentDialog(!1),n.error(e);(R={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=t,J(R,L,W(o)&&!o.keepAudio)}))}else if("firefox"===q.webRTCAdapter.browserDetails.browser){if(!(q.webRTCAdapter.browserDetails.version>=33)){var B=new Error("NavigatorUserMediaError");return B.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",a.consentDialog(!1),void n.error(B)}R={video:{mozMediaSource:o.video,mediaSource:o.video},audio:W(o)&&!o.keepAudio},J(R,(function(e,t){if(L(e,t),!e)var n=t.currentTime,r=window.setInterval((function(){t||window.clearInterval(r),t.currentTime==n&&(window.clearInterval(r),t.onended&&t.onended()),n=t.currentTime}),500)}))}return}}o&&"screen"===o.video||navigator.mediaDevices.enumerateDevices().then((function(t){var i=t.some((function(e){return"audioinput"===e.kind})),s=function(e){if(q.debug("isScreenSendEnabled:",e),!e)return!1;if("object"!==typeof e.video||"object"!==typeof e.video.mandatory)return!1;var t=e.video.mandatory;if(t.chromeMediaSource)return"desktop"===t.chromeMediaSource||"screen"===t.chromeMediaSource;if(t.mozMediaSource)return"window"===t.mozMediaSource||"screen"===t.mozMediaSource;if(t.mediaSource)return"window"===t.mediaSource||"screen"===t.mediaSource;return!1}(o)||t.some((function(e){return"videoinput"===e.kind})),c=W(o),l=H(o),d=function(e){return q.debug("isAudioSendRequired:",e),!!e&&(!1!==e.audio&&!1!==e.audioSend&&(void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio))}(o),u=function(e){return q.debug("isVideoSendRequired:",e),!!e&&(!1!==e.video&&!1!==e.videoSend&&(void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo))}(o);if(c||l||d||u){var m=!!c&&i,f=!!l&&s;if(!m&&!f)return a.consentDialog(!1),n.error("No capture device found"),!1;if(!m&&d)return a.consentDialog(!1),n.error("Audio capture is required, but no capture device found"),!1;if(!f&&u)return a.consentDialog(!1),n.error("Video capture is required, but no capture device found"),!1}var g={audio:!(!i||o.keepAudio)&&x,video:!(!s||o.keepVideo)&&A};q.debug("getUserMedia constraints",g),g.audio||g.video?navigator.mediaDevices.getUserMedia(g).then((function(t){a.consentDialog(!1),V(e,r,o,n,t)})).catch((function(e){a.consentDialog(!1),n.error({code:e.code,name:e.name,message:e.message})})):(a.consentDialog(!1),V(e,r,o,n,k))})).catch((function(e){a.consentDialog(!1),n.error("enumerateDevices error",e)}))}else V(e,r,o,n)}function F(e,t){(t=t||{}).success="function"==typeof t.success?t.success:q.noop,t.error="function"==typeof t.error?t.error:G;var n=t.jsep,r=S[e];if(!r||!r.webrtcStuff)return q.warn("Invalid handle"),void t.error("Invalid handle");var o=r.webrtcStuff;if(n){if(!o.pc)return q.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");o.pc.setRemoteDescription(n).then((function(){if(q.log("Remote description accepted!"),o.remoteSdp=n.sdp,o.candidates&&o.candidates.length>0){for(var e=0;e<o.candidates.length;e++){var r=o.candidates[e];q.debug("Adding remote candidate:",r),r&&!0!==r.completed?o.pc.addIceCandidate(r):o.pc.addIceCandidate(q.endOfCandidates)}o.candidates=[]}t.success()}),t.error)}else t.error("Invalid JSEP")}function L(e,t){var n=S[e];if(!n||!n.webrtcStuff)return q.warn("Invalid handle"),0;var r=t?"remote":"local",o=n.webrtcStuff;return o.volume[r]||(o.volume[r]={value:0}),o.pc.getStats&&"chrome"===q.webRTCAdapter.browserDetails.browser?t&&!o.remoteStream?(q.warn("Remote stream unavailable"),0):t||o.myStream?o.volume[r].timer?o.volume[r].value:(q.log("Starting "+r+" volume monitor"),o.volume[r].timer=setInterval((function(){o.pc.getStats().then((function(e){for(var n=e.result(),a=0;a<n.length;a++){var i=n[a];"ssrc"==i.type&&(t&&i.stat("audioOutputLevel")?o.volume[r].value=parseInt(i.stat("audioOutputLevel")):!t&&i.stat("audioInputLevel")&&(o.volume[r].value=parseInt(i.stat("audioInputLevel"))))}}))}),200),0):(q.warn("Local stream unavailable"),0):(q.warn("Getting the "+r+" volume unsupported by browser"),0)}function J(e,t){var n=S[e];if(!n||!n.webrtcStuff)return q.warn("Invalid handle"),!0;var r=n.webrtcStuff;return r.pc?r.myStream?t?r.myStream.getVideoTracks()&&0!==r.myStream.getVideoTracks().length?!r.myStream.getVideoTracks()[0].enabled:(q.warn("No video track"),!0):r.myStream.getAudioTracks()&&0!==r.myStream.getAudioTracks().length?!r.myStream.getAudioTracks()[0].enabled:(q.warn("No audio track"),!0):(q.warn("Invalid local MediaStream"),!0):(q.warn("Invalid PeerConnection"),!0)}function _(e,t,n){var r=S[e];if(!r||!r.webrtcStuff)return q.warn("Invalid handle"),!1;var o=r.webrtcStuff;return o.pc?o.myStream?t?o.myStream.getVideoTracks()&&0!==o.myStream.getVideoTracks().length?(o.myStream.getVideoTracks()[0].enabled=!n,!0):(q.warn("No video track"),!1):o.myStream.getAudioTracks()&&0!==o.myStream.getAudioTracks().length?(o.myStream.getAudioTracks()[0].enabled=!n,!0):(q.warn("No audio track"),!1):(q.warn("Invalid local MediaStream"),!1):(q.warn("Invalid PeerConnection"),!1)}function U(e){var t=S[e];if(!t||!t.webrtcStuff)return q.warn("Invalid handle"),"Invalid handle";var n=t.webrtcStuff;return n.pc?n.pc.getStats?n.bitrate.timer?n.bitrate.value:(q.log("Starting bitrate timer (via getStats)"),n.bitrate.timer=setInterval((function(){n.pc.getStats().then((function(e){e.forEach((function(e){if(e){var t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(n.bitrate.bsnow=e.bytesReceived,n.bitrate.tsnow=e.timestamp,null===n.bitrate.bsbefore||null===n.bitrate.tsbefore)n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow;else{var r=n.bitrate.tsnow-n.bitrate.tsbefore;"safari"===q.webRTCAdapter.browserDetails.browser&&(r/=1e3);var o=Math.round(8*(n.bitrate.bsnow-n.bitrate.bsbefore)/r);"safari"===q.webRTCAdapter.browserDetails.browser&&(o=parseInt(o/1e3)),n.bitrate.value=o+" kbits/sec",n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow}}}))}))}),1e3),"0 kbits/sec"):(q.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function G(e){q.error("WebRTC error:",e)}function B(e,r){q.log("Cleaning WebRTC stuff");var o=S[e];if(o){var a=o.webrtcStuff;if(a){if(!0===r){var i={janus:"hangup",transaction:q.randomString(12)};o.token&&(i.token=o.token),v&&(i.apisecret=v),q.debug("Sending hangup request (handle="+e+"):"),q.debug(i),t?(i.session_id=w,i.handle_id=e,n.send(JSON.stringify(i))):q.httpAPICall(s+"/"+w+"/"+e,{verb:"POST",withCredentials:m,body:i})}a.remoteStream=null,a.volume&&(a.volume.local&&a.volume.local.timer&&clearInterval(a.volume.local.timer),a.volume.remote&&a.volume.remote.timer&&clearInterval(a.volume.remote.timer)),a.volume={},a.bitrate.timer&&clearInterval(a.bitrate.timer),a.bitrate.timer=null,a.bitrate.bsnow=null,a.bitrate.bsbefore=null,a.bitrate.tsnow=null,a.bitrate.tsbefore=null,a.bitrate.value=null;try{if(!a.streamExternal&&a.myStream){q.log("Stopping local stream tracks");var c=a.myStream.getTracks(),l=!0,d=!1,u=void 0;try{for(var f,g=c[Symbol.iterator]();!(l=(f=g.next()).done);l=!0){var p=f.value;q.log(p),p&&p.stop()}}catch(b){d=!0,u=b}finally{try{l||null==g.return||g.return()}finally{if(d)throw u}}}}catch(h){}a.streamExternal=!1,a.myStream=null;try{a.pc.close()}catch(h){}a.pc=null,a.candidates=null,a.mySdp=null,a.remoteSdp=null,a.iceDone=!1,a.dataChannel={},a.dtmfSender=null}o.oncleanup()}}function W(e){return q.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function z(e){return q.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function H(e){return q.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function K(e){return q.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}D(e),this.getServer=function(){return s},this.isConnected=function(){return y},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:q.noop,e.error="function"==typeof e.error?e.error:q.noop,e.reconnect=!0,D(e)},this.getSessionId=function(){return w},this.destroy=function(a){!function(a){(a=a||{}).success="function"==typeof a.success?a.success:q.noop;var i=!0;void 0!==a.asyncRequest&&null!==a.asyncRequest&&(i=!0===a.asyncRequest);var c=!0;void 0!==a.notifyDestroyed&&null!==a.notifyDestroyed&&(c=!0===a.notifyDestroyed);var l=!1;void 0!==a.cleanupHandles&&null!==a.cleanupHandles&&(l=!0===a.cleanupHandles);if(q.log("Destroying session "+w+" (async="+i+")"),!w)return q.warn("No session to destroy"),a.success(),void(c&&e.destroyed());if(l)for(var d in S)N(d,{noRequest:!0});if(!y)return q.warn("Is the server down? (connected=false)"),void a.success();var u={janus:"destroy",transaction:q.randomString(12)};g&&(u.token=g);v&&(u.apisecret=v);if(t){u.session_id=w;var f=function(){for(var e in r)n.removeEventListener(e,r[e]);n.removeEventListener("message",p),n.removeEventListener("error",b),o&&clearTimeout(o),n.close()},p=function(t){var n=JSON.parse(t.data);n.session_id==u.session_id&&n.transaction==u.transaction&&(f(),a.success(),c&&e.destroyed())},b=function(t){f(),a.error("Failed to destroy the server: Is the server down?"),c&&e.destroyed()};return n.addEventListener("message",p),n.addEventListener("error",b),void n.send(JSON.stringify(u))}q.httpAPICall(s+"/"+w,{verb:"POST",async:i,withCredentials:m,body:u,success:function(t){q.log("Destroyed session:"),q.debug(t),w=null,y=!1,"success"!==t.janus&&q.error("Ooops: "+t.error.code+" "+t.error.reason),a.success(),c&&e.destroyed()},error:function(t,n){q.error(t+":",n),w=null,y=!1,a.success(),c&&e.destroyed()}})}(a)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:q.noop,e.error="function"==typeof e.error?e.error:q.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:q.noop,e.iceState="function"==typeof e.iceState?e.iceState:q.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:q.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:q.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:q.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:q.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:q.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:q.noop,e.ondata="function"==typeof e.ondata?e.ondata:q.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:q.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:q.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:q.noop,!y)return q.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var r=e.plugin;if(!r)return q.error("Invalid plugin"),void e.error("Invalid plugin");var o=e.opaqueId,a=e.token?e.token:g,i=q.randomString(12),c={janus:"attach",plugin:r,opaque_id:o,transaction:i};a&&(c.token=a);v&&(c.apisecret=v);if(t)return C[i]=function(t){if(q.debug(t),"success"!==t.janus)return q.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var n=t.data.id;q.log("Created handle: "+n);var o={session:k,plugin:r,id:n,token:a,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return n},getPlugin:function(){return r},getVolume:function(){return L(n,!0)},getRemoteVolume:function(){return L(n,!0)},getLocalVolume:function(){return L(n,!1)},isAudioMuted:function(){return J(n,!1)},muteAudio:function(){return _(n,!1,!0)},unmuteAudio:function(){return _(n,!1,!1)},isVideoMuted:function(){return J(n,!0)},muteVideo:function(){return _(n,!0,!0)},unmuteVideo:function(){return _(n,!0,!1)},getBitrate:function(){return U(n)},send:function(e){P(n,e)},data:function(e){A(n,e)},dtmf:function(e){I(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){M(n,!0,e)},createAnswer:function(e){M(n,!1,e)},handleRemoteJsep:function(e){F(n,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){B(n,!0===e)},detach:function(e){N(n,e)}};S[n]=o,e.success(o)},c.session_id=w,void n.send(JSON.stringify(c));q.httpAPICall(s+"/"+w,{verb:"POST",withCredentials:m,body:c,success:function(t){if(q.debug(t),"success"!==t.janus)return q.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var n=t.data.id;q.log("Created handle: "+n);var o={session:k,plugin:r,id:n,token:a,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return n},getPlugin:function(){return r},getVolume:function(){return L(n,!0)},getRemoteVolume:function(){return L(n,!0)},getLocalVolume:function(){return L(n,!1)},isAudioMuted:function(){return J(n,!1)},muteAudio:function(){return _(n,!1,!0)},unmuteAudio:function(){return _(n,!1,!1)},isVideoMuted:function(){return J(n,!0)},muteVideo:function(){return _(n,!0,!0)},unmuteVideo:function(){return _(n,!0,!1)},getBitrate:function(){return U(n)},send:function(e){P(n,e)},data:function(e){A(n,e)},dtmf:function(e){I(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){M(n,!0,e)},createAnswer:function(e){M(n,!1,e)},handleRemoteJsep:function(e){F(n,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){B(n,!0===e)},detach:function(e){N(n,e)}};S[n]=o,e.success(o)},error:function(e,t){q.error(e+":",t)}})}(e)}}q.useDefaultDependencies=function(e){var t=e&&e.fetch||fetch,n=e&&e.Promise||Promise,r=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},extension:e&&e.extension||J,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||L.a,httpAPICall:function(e,r){var o={method:r.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===r.verb&&(o.headers["Content-Type"]="application/json"),void 0!==r.withCredentials&&(o.credentials=!0===r.withCredentials?"include":r.withCredentials?r.withCredentials:"omit"),r.body&&(o.body=JSON.stringify(r.body));var a=t(e,o).catch((function(e){return n.reject({message:"Probably a network error, is the server down?",error:e})}));if(r.timeout){var i=new n((function(e,t){var n=setTimeout((function(){return clearTimeout(n),t({message:"Request timed out",timeout:r.timeout})}),r.timeout)}));a=n.race([a,i])}return a.then((function(e){return e.ok?typeof r.success===typeof q.noop?e.json().then((function(e){r.success(e)})).catch((function(t){return n.reject({message:"Failed to parse response body",error:t,response:e})})):void 0:n.reject({message:"API call failed",response:e})})).catch((function(e){typeof r.error===typeof q.noop&&r.error(e.message||"<< internal error >>",e)})),a}}},q.noop=function(){},q.dataChanDefaultLabel="JanusDataChannel",q.endOfCandidates=null,q.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:q.noop,q.initDone)e.callback();else{if("undefined"!=typeof console&&"undefined"!=typeof console.log||(console={log:function(){}}),q.trace=q.noop,q.debug=q.noop,q.vdebug=q.noop,q.log=q.noop,q.warn=q.noop,q.error=q.noop,!0===e.debug||"all"===e.debug)q.trace=console.trace.bind(console),q.debug=console.debug.bind(console),q.vdebug=console.debug.bind(console),q.log=console.log.bind(console),q.warn=console.warn.bind(console),q.error=console.error.bind(console);else if(Array.isArray(e.debug)){var t=!0,n=!1,r=void 0;try{for(var o,a=e.debug[Symbol.iterator]();!(t=(o=a.next()).done);t=!0){var i=o.value;switch(i){case"trace":q.trace=console.trace.bind(console);break;case"debug":q.debug=console.debug.bind(console);break;case"vdebug":q.vdebug=console.debug.bind(console);break;case"log":q.log=console.log.bind(console);break;case"warn":q.warn=console.warn.bind(console);break;case"error":q.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+i+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}}catch(h){n=!0,r=h}finally{try{t||null==a.return||a.return()}finally{if(n)throw r}}}q.log("Initializing library");var s=e.dependencies||q.useDefaultDependencies();q.isArray=s.isArray,q.webRTCAdapter=s.webRTCAdapter,q.httpAPICall=s.httpAPICall,q.newWebSocket=s.newWebSocket,q.extension=s.extension,q.extension.init(),q.listDevices=function(e,t){e="function"==typeof e?e:q.noop,null==t&&(t={audio:!0,video:!0}),q.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(t).then((function(t){navigator.mediaDevices.enumerateDevices().then((function(n){q.debug(n),e(n);try{var r=t.getTracks(),o=!0,a=!1,i=void 0;try{for(var s,c=r[Symbol.iterator]();!(o=(s=c.next()).done);o=!0){var l=s.value;l&&l.stop()}}catch(h){a=!0,i=h}finally{try{o||null==c.return||c.return()}finally{if(a)throw i}}}catch(d){}}))})).catch((function(t){q.error(t),e([])})):(q.warn("navigator.mediaDevices unavailable"),e([]))},q.attachMediaStream=function(e,t){try{e.srcObject=t}catch(n){try{e.src=URL.createObjectURL(t)}catch(n){q.error("Error attaching stream to element")}}},q.reattachMediaStream=function(e,t){try{e.srcObject=t.srcObject}catch(n){try{e.src=t.src}catch(n){q.error("Error reattaching stream to element")}}};var c=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",l=window["on"+c];if(window.addEventListener(c,(function(e){for(var t in q.log("Closing window"),q.sessions)q.sessions[t]&&q.sessions[t].destroyOnUnload&&(q.log("Destroying session "+t),q.sessions[t].destroy({asyncRequest:!1,notifyDestroyed:!1}));l&&"function"==typeof l&&l()})),q.safariVp8=!1,"safari"===q.webRTCAdapter.browserDetails.browser&&q.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){var d=!0,u=!1,m=void 0;try{for(var f,g=RTCRtpSender.getCapabilities("video").codecs[Symbol.iterator]();!(d=(f=g.next()).done);d=!0){var v=f.value;if(v&&v.mimeType&&"video/vp8"===v.mimeType.toLowerCase()){q.safariVp8=!0;break}}}catch(h){u=!0,m=h}finally{try{d||null==g.return||g.return()}finally{if(u)throw m}}q.safariVp8?q.log("This version of Safari supports VP8"):q.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var p=new RTCPeerConnection({},{});p.createOffer({offerToReceiveVideo:!0}).then((function(e){q.safariVp8=-1!==e.sdp.indexOf("VP8"),q.safariVp8?q.log("This version of Safari supports VP8"):q.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),p.close(),p=null}))}if(q.unifiedPlan=!1,"firefox"===q.webRTCAdapter.browserDetails.browser&&q.webRTCAdapter.browserDetails.version>=59)q.unifiedPlan=!0;else if("chrome"===q.webRTCAdapter.browserDetails.browser&&q.webRTCAdapter.browserDetails.version<72)q.unifiedPlan=!1;else{var b=new RTCPeerConnection;try{b.addTransceiver("audio"),q.unifiedPlan=!0}catch(y){}b.close()}q.initDone=!0,e.callback()}},q.isWebrtcSupported=function(){return!!window.RTCPeerConnection},q.isGetUserMediaAvailable=function(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)},q.randomString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",r=0;r<e;r++){var o=Math.floor(Math.random()*t.length);n+=t.substring(o,o+1)}return n};var _=function(e){var t=e.session,n=e.opaqueId,r=e.callbacks;return new Promise((function(e,o){var a=null;t.attach({plugin:"janus.plugin.videoroom",opaqueId:n,success:function(t){a=t,q.log("Plugin attached! ("+t.getPlugin()+", id="+t.getId()+")"),q.log("  -- This is a publisher/manager"),e(t)},error:function(e){q.error("  -- Error attaching plugin...",e),o(e)},consentDialog:function(e){q.debug("Consent dialog should be "+(e?"on":"off")+" now")},mediaState:function(e,t){q.log("Janus "+(t?"started":"stopped")+" receiving our "+e)},webrtcState:function(e){q.log("Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now")},onmessage:function(e,t){q.debug(" ::: Got a message (publisher) :::"),q.debug(e);var n=e.videoroom;if(q.debug("Event: "+n),void 0!==n&&null!==n)if("joined"===n)console.log("Event is joined!"),r.onRoomJoined&&r.onRoomJoined(e);else if("destroyed"===n)q.warn("The room has been destroyed!"),r.onRoomDestroyed&&r.onRoomDestroyed(e.room);else if("event"===n)if(void 0!==e.publishers&&null!==e.publishers){var o=e.publishers;q.debug("Got publishers:"),q.debug(o),r.onGotPublishers&&r.onGotPublishers(e)}else if(void 0!==e.joining&&null!==e.joining){var i=e.joining;q.log("Participant joined: "+i.display),r.onParticipantJoined&&r.onParticipantJoined(e)}else if(void 0!==e.leaving&&null!==e.leaving)r.onParticipantLeft&&r.onParticipantLeft(e);else if(void 0!==e.unpublished&&null!==e.unpublished){var s=e.unpublished;if(r.onPublisherLeft&&r.onPublisherLeft(s),"ok"===s)return}else void 0!==e.error&&null!==e.error&&r.onErrorEvent&&r.onErrorEvent(e);void 0!==t&&null!==t&&(q.debug("Handling SDP as well..."),q.debug(t),a.handleRemoteJsep({jsep:t}))},onlocalstream:function(e){q.debug(" ::: Got a local stream :::"),r.onLocalStream&&r.onLocalStream(e)},onremotestream:function(e){console.log("Got remote stream: ",e)},oncleanup:function(){q.log(" ::: Got a cleanup notification: we are unpublished now :::"),r.onPluginCleanup&&r.onPluginCleanup()}})}))},U=function(e,t,n){return new Promise((function(r,o){console.log("Kick participant from room: ".concat(t," with userID: ").concat(n)," - videoRoomAPI: ",e);var a={request:"kick",room:t,id:n};e.send({message:a,success:function(e){console.log("Kick participant from room: ".concat(t," with userID: ").concat(n," -> result: ")+JSON.stringify(e)),r()},error:function(e){console.log("Sent kick request failed for room: ",t," - error: ",e),o(e)}})}))},G=function(e,t){return new Promise((function(n,r){var o={request:"listparticipants",room:t};e.send({message:o,success:function(e){if(void 0!==e.error&&null!==e.error)r(e.error);else{var t=e.participants;n(t)}}})}))},B=function(e){return new Promise((function(t,n){e.send({message:{request:"unpublish"},success:function(){t()}})}))},W=n(258),z=n.n(W),H=function(e){var t=e.publisher,n=e.connection,o=e.currentRoom,a=e.myPrivateId,i=t.id,c=t.video_codec,l=Object(r.useState)(null),d=Object(s.a)(l,2),u=d[0],m=d[1],f=Object(r.useState)(null),g=Object(s.a)(f,2),v=g[0],p=g[1],b=Object(r.useState)(null),h=Object(s.a)(b,2),y=h[0],S=h[1],k=Object(r.useRef)(!1),E=Object(r.useCallback)((function(e){console.error("Encountered error: ",e)}),[]),C=Object(r.useCallback)((function(e){console.log("Got remote stream: ",e),p(e)}),[]),j=Object(r.useCallback)((function(e){console.log("Attached to feed: ",e),S({username:e.display,id:e.id})}),[]),O=Object(r.useState)((function(){return{onAttachedToFeed:j,onRemoteStream:C,onErrorEvent:E}})),T=Object(s.a)(O,1)[0];Object(r.useEffect)((function(){console.log("useRemoteFeed -> onRemoteStream changed: ",C),T.onRemoteStream=C}),[C]),Object(r.useEffect)((function(){console.log("useRemoteFeed -> onAttachedToFeed changed: ",j),T.onAttachedToFeed=j}),[j]);var D=Object(r.useCallback)((function(e,t){console.log("initializeStream"),function(e){var t=e.session,n=e.id,r=e.myPrivateId,o=e.opaqueId,a=e.video_codec,i=e.currentRoom,s=e.callbacks;return new Promise((function(e,c){var l=null;t.attach({plugin:"janus.plugin.videoroom",opaqueId:o,success:function(t){(l=t).simulcastStarted=!1,q.log("Plugin attached! ("+l.getPlugin()+", id="+l.getId()+")"),q.log("  -- This is a subscriber"),e(t);var o={request:"join",room:i,ptype:"subscriber",feed:n,private_id:r};"safari"!==q.webRTCAdapter.browserDetails.browser||"vp9"!==a&&("vp8"!==a||q.safariVp8)||(a&&(a=a.toUpperCase()),w.a.warning({content:"Publisher is using "+a+", but Safari doesn't support it: disabling video"}),o.offer_video=!1),l.videoCodec=a,l.send({message:o})},error:function(e){q.error("  -- Error attaching plugin...",e),c(e)},onmessage:function(e,t){q.debug(" ::: Got a message (subscriber) :::"),q.debug(e);var n=e.videoroom;if(q.debug("Event: "+n),void 0!==e.error&&null!==e.error)s.onErrorEvent&&s.onErrorEvent(e);else if(void 0!==n&&null!=n)if("attached"===n)console.log("Username for video is: ",e.display),console.log("Id for video is: ",e.id),q.log("Successfully attached to feed "+e.id+" ("+e.display+") in room "+e.room),s.onAttachedToFeed&&s.onAttachedToFeed(e);else if("event"===n){var r=e.substream,o=e.temporal;(null!==r&&void 0!==r||null!==o&&void 0!==o)&&(l.simulcastStarted||(l.simulcastStarted=!0,console.log("Simulcast started")))}void 0!==t&&null!==t&&(q.debug("Handling SDP as well..."),q.debug(t),l.createAnswer({jsep:t,media:{audioSend:!1,videoSend:!1},success:function(e){q.debug("Got SDP!"),q.debug(e);var t={request:"start",room:i};l.send({message:t,jsep:e})},error:function(e){q.error("WebRTC error:",e),s.onErrorEvent&&s.onErrorEvent("WebRTC error: "+JSON.stringify(e))}}))},webrtcState:function(e){q.log("useRemoteFeed -> Janus says this WebRTC PeerConnection is "+(e?"up":"down")+" now")},onlocalstream:function(e){},onremotestream:function(e){console.log("useRemoteFeed - got remote stream: ",e);var t=e.getVideoTracks();null===t||void 0===t||0===t.length?(console.log("No remote video available"),s.onErrorEvent&&s.onErrorEvent("No remote video available")):(console.log("we have remote video! yey!"),s.onRemoteStream&&s.onRemoteStream(e))},oncleanup:function(){q.log(" ::: Got a cleanup notification (remote feed "+n+") :::"),console.log("We should do cleanup")}})}))}({session:e.session,id:i,myPrivateId:a,video_codec:c,currentRoom:o,opaqueId:e.opaqueId,callbacks:t}).then((function(e){console.log("useRemoteFeed -> onPluginAttached:  ",e),m(e)})).catch((function(e){console.log("useRemoteFeed -> error attaching plugin: ",e)}))}),[o,i,a,c]);return k.current||(D(n,T),k.current=!0),[u,v,y]},K=function(e){var t=e.publisher,n=e.connection,a=e.myPrivateId,i=e.currentRoom,c=e.className,l=Object(r.useState)({}),d=Object(s.a)(l,2),u=(d[0],d[1],Object(r.useState)(null)),m=Object(s.a)(u,2),f=(m[0],m[1],Object(r.useRef)()),g=H({videoRef:f,publisher:t,connection:n,currentRoom:i,myPrivateId:a}),v=Object(s.a)(g,3),p=v[0],b=v[1],h=v[2];Object(r.useEffect)((function(){if(console.log("remoteStream changed: ",b),b){var e=f.current;console.log("videoELement este: ",e),q.attachMediaStream(e,b),console.log("playing remoteStream"),e.play()}else console.log("invalid remote stream")}),[b]),Object(r.useEffect)((function(){if(p)return console.log("videoRoomAPI is: ",p),function(){console.log("Doing cleanup here - videoRoomAPI is: ",p),p.detach()};console.log("No remote feed")}),[p]);return null===h?null:o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"relative "+c},o.a.createElement("video",{className:c,style:{maxHeight:"100vh"},ref:f,autoPlay:!0,playsInline:!0,onPlaying:function(){console.log("Video is now playing!! - videoRoomAPI: ",p)}}),o.a.createElement("div",{className:"absolute top-0 left-0 right-0 h-8 opacity-50 faded-down-50"},o.a.createElement("span",{className:"absolute top-0 left-0 py-4 px-4 text-white text-lg font-medium select-none"},h.username))))},Y=function(){return o.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",fill:"currentColor",viewBox:"0 0 352 512"},o.a.createElement("path",{fill:"currentColor",d:"M176 352c53.02 0 96-42.98 96-96V96c0-53.02-42.98-96-96-96S80 42.98 80 96v160c0 53.02 42.98 96 96 96zm160-160h-16c-8.84 0-16 7.16-16 16v48c0 74.8-64.49 134.82-140.79 127.38C96.71 376.89 48 317.11 48 250.3V208c0-8.84-7.16-16-16-16H16c-8.84 0-16 7.16-16 16v40.16c0 89.64 63.97 169.55 152 181.69V464H96c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16h-56v-33.77C285.71 418.47 352 344.9 352 256v-48c0-8.84-7.16-16-16-16z"}))},Q=function(){return o.a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 640 512",width:"1em",height:"1em",fill:"currentColor"},o.a.createElement("path",{fill:"currentColor",d:"M633.82 458.1l-157.8-121.96C488.61 312.13 496 285.01 496 256v-48c0-8.84-7.16-16-16-16h-16c-8.84 0-16 7.16-16 16v48c0 17.92-3.96 34.8-10.72 50.2l-26.55-20.52c3.1-9.4 5.28-19.22 5.28-29.67V96c0-53.02-42.98-96-96-96s-96 42.98-96 96v45.36L45.47 3.37C38.49-2.05 28.43-.8 23.01 6.18L3.37 31.45C-2.05 38.42-.8 48.47 6.18 53.9l588.36 454.73c6.98 5.43 17.03 4.17 22.46-2.81l19.64-25.27c5.41-6.97 4.16-17.02-2.82-22.45zM400 464h-56v-33.77c11.66-1.6 22.85-4.54 33.67-8.31l-50.11-38.73c-6.71.4-13.41.87-20.35.2-55.85-5.45-98.74-48.63-111.18-101.85L144 241.31v6.85c0 89.64 63.97 169.55 152 181.69V464h-56c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16z"}))},Z=function(e){return o.a.createElement(M.a,Object.assign({component:Y},e))},X=function(e){return o.a.createElement(M.a,Object.assign({component:Q},e))},$=function(e){var t=e.muted,n=e.toggle,a=Object(O.a)(e,["muted","toggle"]),i=Object(r.useCallback)((function(){null!==n&&void 0!==n&&n()}),[n]);return o.a.createElement("span",Object.assign({onClick:i},a),!1===t&&o.a.createElement(Z,{className:"text-black"}),!0===t&&o.a.createElement(X,{className:"text-black"}))},ee=n(179),te=function(e){var t=e.connection,n=Object(r.useState)(null),o=Object(s.a)(n,2),a=o[0],i=o[1],c=Object(r.useState)(null),l=Object(s.a)(c,2),d=l[0],u=l[1],m=Object(r.useState)(null),f=Object(s.a)(m,2),g=f[0],v=f[1],p=Object(r.useState)(!1),b=Object(s.a)(p,2),h=b[0],y=b[1],w=Object(r.useState)(null),S=Object(s.a)(w,2),k=S[0],E=S[1],C=Object(r.useState)(!1),j=Object(s.a)(C,2),O=j[0],T=j[1],D=Object(r.useState)(0),P=Object(s.a)(D,2),R=P[0],x=P[1],A=Object(r.useState)([]),I=Object(s.a)(A,2),N=I[0],V=I[1],M=Object(r.useState)(!1),L=Object(s.a)(M,2),J=L[0],U=L[1],W=Object(r.useState)(null),z=Object(s.a)(W,2),H=z[0],K=z[1],Y=Object(r.useState)(!1),Q=Object(s.a)(Y,2),Z=Q[0],X=Q[1],$=Object(r.useState)({}),te=Object(s.a)($,2),ne=te[0],re=te[1],oe=Object(r.useState)({onParticipantJoined:function(){},onParticipantLeft:function(){}}),ae=Object(s.a)(oe,2),ie=ae[0],se=(ae[1],Object(r.useCallback)((function(e){_({opaqueId:t.opaqueId,session:t.session,callbacks:e}).then((function(e){console.log("onPluginAttached: ",e),u(e),X(!0)})).catch((function(e){console.log("Error attaching plugin: ",e)}))}),[]));Object(r.useEffect)((function(){return console.log("leaveRequestInProgress changed: ",h)}),[h]);var ce=Object(r.useCallback)((function(e,t,n){return new Promise((function(r,o){(function(e,t,n,r){return new Promise((function(o,a){console.log("Joining room: ".concat(t," with username: ").concat(n," and userID: ").concat(r)," - videoRoomAPI: ",e);var i={request:"join",ptype:"publisher",room:t,id:r,display:n};e.send({message:i,success:function(e){console.log("Sent join request for room: ",t),o()},error:function(e){console.log("Sent join request failed for room: ",t," - error: ",e),a(e)}})}))})(d,e,t,n).then((function(e){return r(e)})).catch((function(e){return o(e)}))}))}),[d]),le=Object(r.useCallback)((function(){return y(!0),J?B(d).then((function(){console.log(" leaveRoom -> We are now unpublishing video"),U(!1),E(null)})):function(e){return new Promise((function(t,n){console.log("Leaving room");e.send({message:{request:"leave"},success:function(){console.log("Sent leave request"),t()}})}))}(d)}),[d,J]),de=Object(r.useCallback)((function(e){return function(e,t){return new Promise((function(n,r){e.createOffer({media:{audioRecv:!1,videoRecv:!1,audioSend:t,videoSend:!0},success:function(r){q.debug("Got publisher SDP!"),q.debug(r);var o={request:"configure",audio:t,video:!0};e.send({message:o,jsep:r,success:function(e){console.log("Published succesful!"),n()}})},error:function(e){q.error("WebRTC error:",e),r(e)}})}))}(d,e).then((function(){console.log("We are now publishing video"),T(d.isAudioMuted()),U(!0)}))}),[d]),ue=Object(r.useCallback)((function(){return B(d).then((function(){console.log("We are now unpublishing video")}))}),[d]),me=Object(r.useCallback)((function(e){console.log("Got local stream: ",e),E(e)}),[]),fe=Object(r.useCallback)((function(e){console.error("Encountered error: ",e)}),[]),ge=Object(r.useCallback)((function(e){console.log("refreshParticipants - roomId: ",e),G(d,e).then((function(e){var t={};e.forEach((function(e,n){var r=e.id;t[r]={name:e.display}})),re(t),console.log("newParticipants: ",t)}))}),[d]),ve=Object(r.useCallback)((function(e){console.log("Room joined: ",e),d.send({message:{request:"configure",bitrate:0}});var t=e.id,n=e.room,r=e.description,o=e.id;if(i({id:t,private_id:o}),q.log("Successfully joined room "+e.room+" with ID "+t),K({id:n,description:r,userID:t}),ge(n),v(!0),void 0!==e.publishers&&null!==e.publishers){var a=e.publishers;q.debug("Got a list of available publishers/feeds:"),q.debug(a),console.log("Setting publishers list: ",a),V(a)}else console.log("Setting empty publishers list"),V([])}),[d]),pe=Object(r.useCallback)((function(e){if(console.log("Publisher left: ",e),"ok"===e)!0===h?(console.log("We left the room"),v(!1),console.log("Closing plugin handle"),d.hangup(),d.detach()):(console.log("We stopped streaming local video"),U(!1),E(null));else{console.log("onPublisherLeft - Existing publishers: ",N);var t=N.filter((function(t){return t.id!==e}));console.log("onPublisherLeft - New publishers: ",t),N.length!==t.length&&V(t)}}),[N,h]),be=Object(r.useCallback)((function(e){console.log("Got publishers: ",e);var t=e.publishers;console.log("onPublisher joined: Existing publishers list is: ",N);var n=Object(ee.a)(N);n.push.apply(n,Object(ee.a)(t)),console.log("Setting publishers list: ",n),V(n)}),[N]),he=Object(r.useCallback)((function(e){var t=e.joining;console.log("New participant: ",t),ge(H.id),ie.onParticipantJoined&&ie.onParticipantJoined({id:t.id,name:t.display})}),[ie,ne]),ye=Object(r.useCallback)((function(e){var t=e.leaving;if(console.log("Participant left id: ",t),"ok"===t)!0===h&&(console.log("We left the room"),v(!1));else{var n=ne[t];ge(H.id),ie.onParticipantLeft&&ie.onParticipantLeft(Object(F.a)({},n,{id:t}))}}),[h,ne,ie]),we=Object(r.useState)((function(){return{onLocalStream:me,onErrorEvent:fe,onRoomJoined:ve,onGotPublishers:be,onParticipantJoined:he,onParticipantLeft:ye,onPublisherLeft:pe}})),Se=Object(s.a)(we,1)[0],ke=Object(r.useRef)(!1);ke.current||(se(Se),ke.current=!0),Object(r.useEffect)((function(){Se.onRoomJoined=ve}),[ve]),Object(r.useEffect)((function(){Se.onGotPublishers=be}),[be]),Object(r.useEffect)((function(){Se.onParticipantJoined=he}),[he]),Object(r.useEffect)((function(){Se.onParticipantLeft=ye}),[ye]),Object(r.useEffect)((function(){Se.onPublisherLeft=pe}),[pe]),Object(r.useEffect)((function(){Se.onLocalStream=me}),[me]);var Ee=Object(r.useCallback)((function(){var e=d.isAudioMuted();q.log((e?"Unmuting":"Muting")+" local stream..."),e?d.unmuteAudio():d.muteAudio(),e=d.isAudioMuted(),T(e)}),[d]),Ce=Object(r.useCallback)((function(e){console.log("Setting bitrate to: ",e),x(e);var t=1e3*parseInt(e);0===t?q.log("Not limiting bandwidth via REMB"):q.log("Capping bandwidth to "+t+" via REMB"),d.send({message:{request:"configure",bitrate:t}})}),[d]);return[Z,ie,ne,N,H,g,a,ce,le,k,J,de,ue,Ee,O,R,Ce]},ne=function(e){var t=e.className;return o.a.createElement("svg",{viewBox:"64 64 896 896",focusable:"false",className:t,"data-icon":"video-camera",fill:"currentColor"},o.a.createElement("path",{d:"M912 302.3L784 376V224c0-35.3-28.7-64-64-64H128c-35.3 0-64 28.7-64 64v576c0 35.3 28.7 64 64 64h592c35.3 0 64-28.7 64-64V648l128 73.7c21.3 12.3 48-3.1 48-27.6V330c0-24.6-26.7-40-48-27.7zM712 792H136V232h576v560zm176-167l-104-59.8V458.9L888 399v226zM208 360h112c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H208c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8z"}))},re=(n(513),E.a.Option),oe=function(e){var t=e.connection,n=e.onRoomJoined,a=e.onRoomLeft,i=e.roomToJoin,c=m(),l=c.userInfo,d=c.isDJ,u=c.backendServer,f=Object(r.useState)(!1),g=Object(s.a)(f,2),v=g[0],p=g[1],h=Object(r.useState)(null),y=Object(s.a)(h,2),w=y[0],S=y[1],k=Object(r.useState)({}),C=Object(s.a)(k,2),j=C[0],O=C[1],T=Object(r.useRef)(null),D=te({connection:t}),P=Object(s.a)(D,17),R=P[0],x=P[1],A=P[2],I=P[3],N=P[4],V=P[5],L=P[6],J=P[7],_=P[8],U=P[9],G=P[10],B=P[11],W=P[12],H=P[13],Y=P[14],Q=P[15],Z=P[16],X=Object(r.useCallback)((function(e){e&&(q.attachMediaStream(e,U),console.log("Playing local stream"),e.play())}),[U]);Object(r.useEffect)((function(){console.log("Participants changed: ",A)}),[A]),Object(r.useEffect)((function(){console.log("VideoRoom constructor");var e="".concat(document.location.origin);if(!0===d){var t=z()(e);S(t),console.log("Socket for: ",e," -> ",t)}return function(){console.log("VideoRoom destructor"),!0===G&&W()}}),[]);var ee=Object(r.useCallback)((function(e){var t=e.user_id,n=e.user_name,r=e.image,o=Object(F.a)({},j);o[t]={name:n,image:r},O(o)}),[]);Object(r.useEffect)((function(){w&&!1===v&&(w.on("got_user_image",ee),p(!0))}),[w]);var oe=Object(r.useCallback)((function(e){console.log("Participant joined: ",e)}),[]),ae=Object(r.useCallback)((function(e){console.log("Participant left: ",e);var t=Object(F.a)({},j);delete t[e.id],O(t)}),[j]);Object(r.useEffect)((function(){(console.log("isPluginAttached changed to: ",R),!0===R)&&(x.onParticipantJoined=oe,x.onParticipantLeft=ae,J(i,c.userInfo.username,void 0))}),[R]),Object(r.useEffect)((function(){x.onParticipantLeft=ae}),[ae]),Object(r.useEffect)((function(){x.onParticipantJoined=oe}),[oe]),Object(r.useEffect)((function(){console.log("isRoomJoined changed to: ",V);var e=l.username;!0===V?(n&&n({user_id:N.userID,user_name:e,user_room:N.id,image_send_url:u+"send_image"}),null!==w&&(console.log("Facem emit - join"),w.emit("message",{action:"join",room:N.id,user_id:N.userID,user_name:e}))):null!==N&&(a&&a({user_id:N.userID,user_name:e,user_room:N.id,image_send_url:u+"send_image"}),null!==w&&(console.log("Facem emit - leave"),w.emit("message",{action:"leave",room:N.id,user_id:N.userID,user_name:e})))}),[V]),Object(r.useEffect)((function(){if(console.log("localStream changed: ",U),null!==U){var e=X.current;console.log("My video html element is: ",e),q.attachMediaStream(e,U)}}),[U,X]);var ie=Object(r.useCallback)((function(){var e=T.current;document.fullscreenElement&&null!==document.fullscreenElement||document.webkitFullscreenElement&&null!==document.webkitFullscreenElement||document.mozFullScreenElement&&null!==document.mozFullScreenElement||document.msFullscreenElement&&null!==document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():null!=e&&(e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen?e.webkitRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen())}),[]),se=Object(r.useCallback)((function(){_().then((function(){console.log("leaveRoom -> entered")})).catch((function(e){console.log("Error on leave: ",e)}))}),[_,w,N]),ce=function(e){console.log("Bitrate changed: ",e),Z(e)},le=Object(r.useCallback)((function(){!0===G?W():B(!0)}),[G,B,W]),de=!1===G&&0===I.length,ue=I.length;!0===G&&(ue+=1);var me=ue<=2?"w-full":"",fe="";switch(ue){case 1:fe="grid-cols-1 grid-rows-1";break;case 2:fe="grid-cols-2 grid-rows-1";break;case 3:case 4:fe="grid-cols-2 grid-rows-2";break;default:fe="grid-cols-3 grid-rows-2"}console.log("localVideoClassName: ",me);if(null===V||!1===V)return console.log("Room not joined. Not rendering anything"),null;return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"flex flex-row justify-between items-baseline py-4"},o.a.createElement("div",{className:"flex flex-row items-baseline select-none"},o.a.createElement("div",null,o.a.createElement(ne,{className:"w-4 h-4 mr-4"})),o.a.createElement("div",{className:"font-semibold text-lg text-gray-400"},N.description)),o.a.createElement("div",{className:"flex flex-row"},o.a.createElement(b.a,{onClick:se},"Leave virtual scene"),!0===c.isDJ&&!1===de&&o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"w-2"}),o.a.createElement(b.a,{type:"primary",onClick:le},G?"Stop Streaming":"Start Streaming")))),o.a.createElement("div",{className:"flex-auto"},0!==Object.keys(j).length&&o.a.createElement("div",{className:"font-semibold text-lg"},"Viewers"),o.a.createElement("div",{className:"flex flex-wrap rounded overflow-auto"},Object.keys(j).map((function(e,t){var n=j[e].image,r=j[e].name;return o.a.createElement("div",{key:e,className:"w-1/2 p-2"},o.a.createElement("div",{className:"-mx-2 flex flex-col border shadow-md rounded overflow-hidden",style:{borderColor:"#444c67",backgroundColor:"rgba(37, 49, 86, 0.48)"}},o.a.createElement("img",{alt:e,src:"data:image/png;base64,"+n}),o.a.createElement("div",{className:"font-semibold p-4"},r)))}))),o.a.createElement("div",{className:"flex flex-row"},o.a.createElement("div",{className:"w-4/5 rounded-l border border-r-0",style:{borderColor:"#444c67"}},!0===de?o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"h-full text-center p-6 ",style:{backgroundColor:"rgba(37, 49, 86, 0.48)",borderColor:"#444c67"}},!0===d?o.a.createElement(o.a.Fragment,null,o.a.createElement("p",{className:"p-6 text-lg"},"Looks like nobody is streaming in this virtual scene.",o.a.createElement("br",null)," ","Would you like to be the first one?"),o.a.createElement(b.a,{type:"primary",onClick:le},G?"Stop Streaming":"Start Streaming")):o.a.createElement("p",{className:"p-6 text-lg"},"No DJ streaming in this virtual scene. Waiting for a DJ to start streaming."))):o.a.createElement("div",{className:"videos-list overflow-auto bg-black relative "+fe,ref:T},!0===G&&o.a.createElement("div",{key:L.id,className:"local-video "+me+" flex items-center justify-center"},o.a.createElement("div",{className:"relative "+me},o.a.createElement("video",{className:me,style:{maxHeight:"100vh"},ref:X,autoPlay:!0,playsInline:!0,muted:!0}),o.a.createElement("div",{className:"absolute top-0 left-0 right-0 h-8 opacity-75 faded-down-50"},o.a.createElement("div",{className:"absolute top-0 left-0 py-4 px-4"},o.a.createElement("span",{className:"text-white text-lg font-medium select-none mr-4"},c.userInfo.username),o.a.createElement(E.a,{defaultValue:"0",value:Q,onChange:ce,className:"w-32"},o.a.createElement(re,{value:0},"Full Quality"),o.a.createElement(re,{value:128},"Cap to 128kbit"),o.a.createElement(re,{value:256},"Cap to 256kbit"),o.a.createElement(re,{value:512},"Cap to 512kbit"),o.a.createElement(re,{value:1024},"Cap to 1mbit"),o.a.createElement(re,{value:1500},"Cap to 1.5mbit"),o.a.createElement(re,{value:2e3},"Cap to 2mbit"))),o.a.createElement($,{className:"absolute top-0 right-0 cursor-pointer text-2xl py-2 px-6 text-white",toggle:H,muted:Y})))),I.map((function(e,n){return o.a.createElement("div",{key:e.id,className:"publisher-video flex items-center justify-center relative"},o.a.createElement(K,{publisher:e,connection:t,myPrivateId:L.private_id,currentRoom:N.id,className:ue<=2?"w-full":""}))})),o.a.createElement("div",{className:"absolute right-0 top-0"},o.a.createElement(b.a,{onClick:ie},"Full screen")))),o.a.createElement("div",{className:"w-1/5 flex-initial flex-col rounded-r border",style:{borderColor:"#444c67",backgroundColor:"rgba(37, 49, 86, 0.48)"}},Object.keys(A).map((function(e,t,n){var r=t!==n.length-1;return o.a.createElement("div",{key:e,className:"select-none truncate p-2 flex-row"},o.a.createElement("div",{className:"flex flex-row items-baseline pb-2"},o.a.createElement(M.a,{type:"user",className:"mr-1",style:{verticalAlign:"0"}}),o.a.createElement("div",{className:"truncate",title:A[e].name}," ",A[e].name)),!0===r&&o.a.createElement("div",{style:{height:"1px",marginBottom:"-1px",backgroundColor:"#4b4860"}}))}))))))},ae="videoroomdj-"+q.randomString(12),ie=function(e){var t=e.server,n=(e.opaqueId,e.onSessionDestroyed);return new Promise((function(e,r){console.log("createSessionAPI called"),q.initDone?console.log("Janus already initialized"):(console.log("Must initialize Janus"),q.init({callback:function(){console.log("janus initialized")}}));var o=new q({server:t,success:function(){e(o)},error:function(e){q.error(e),r(e)},destroyed:function(){n&&n()}})}))},se=function(e){var t=e.server,n=Object(r.useState)(null),o=Object(s.a)(n,2),a=o[0],i=o[1],c=Object(r.useState)([]),l=Object(s.a)(c,2),d=l[0],u=l[1],m=Object(r.useCallback)((function(){console.log("Session destroyed")}),[]),f=Object(r.useCallback)((function(e){console.error("Encountered error: ",e)}),[]),g=Object(r.useCallback)((function(e){ie({server:t,opaqueId:ae,onSessionDestroyed:m}).then((function(t){console.log("Created session: ",t),_({opaqueId:ae,session:t,callbacks:e}).then((function(e){console.log("onPluginAttached: ",e);var n={session:t,api:e,opaqueId:ae};console.log("Settting new connection: ",n),i(n)})).catch((function(e){console.log("Error attaching plugin: ",e)}))})).catch((function(e){return console.log("Error creating session: ",e)}))}),[t,m]),v=Object(r.useCallback)((function(e){var t=e.description,n=e.numPublishers,r=e.notify_joining;return function(e,t,n,r){return new Promise((function(o,a){var i=Number(n||10),s={request:"create",description:t,publishers:i,notify_joining:r||!0};console.log("Creating room with params: ",s),e.send({message:s,success:function(e){return o(e)}})}))}(a.api,t,n,r)}),[a]),p=Object(r.useCallback)((function(e){return function(e,t){return new Promise((function(n,r){var o={request:"destroy",room:t};e.send({message:o,success:function(e){console.log("Destroy result: ",e),n(e)}})}))}(a.api,e)}),[a]),b=Object(r.useCallback)((function(e,t){return U(a.api,e,t)}),[a]);Object(r.useEffect)((function(){console.log("kickFromRoom changed: "+b+" - connection: "+a)}),[b]);var h=Object(r.useCallback)((function(){return e=a.api,new Promise((function(t,n){e.send({message:{request:"list"},success:function(e){var n=e.list.filter((function(e){return 1234!==e.room&&5678!==e.room}));t(n)}})}));var e}),[a]),y=Object(r.useCallback)((function(){h().then((function(e){console.log("Rooms is: ",e),u(e)}))}),[h]),w=Object(r.useCallback)((function(e){return G(a.api,e)}),[a]),S=Object(r.useState)((function(){return{onErrorEvent:f}})),k=Object(s.a)(S,1)[0],E=Object(r.useRef)(!1);return E.current||(g(k),E.current=!0),[a,v,p,h,y,d,w,b]},ce=function(e){var t=e.visibility,n=e.onSuccess,a=e.createRoom,i=Object(s.a)(t,2),c=i[0],l=i[1],d=Object(r.useState)(!1),u=Object(s.a)(d,2),m=u[0],f=u[1],g=Object(r.useCallback)((function(e){e&&e.focus()}),[]),v=Object(r.useCallback)((function(){l(!1)}),[l]),p=Object(r.useCallback)((function(e){a({description:String(e.description),numPublishers:Number(10),notify_joining:!0}).then((function(e){console.log("Room create result: ",e),f(!1),l(!1),n&&n()}))}),[a,n,l]),h=Object(C.a)({initialValues:{description:""},validationSchema:j.object({description:j.string().required("Please enter a description")}),onSubmit:function(e,t){t.setSubmitting;p(e)},validate:function(e){var t={};return e.password!==e.confirmPassword&&(t.passwordConfirmation="Passwords do not match"),console.log("Validate errors is: ",t),t}});return Object(r.useEffect)((function(){console.log("Visibility changed: ",c),!0===c&&h.resetForm()}),[c]),o.a.createElement(w.a,{title:"Create a new virtual scene",visible:c,footer:[o.a.createElement(b.a,{key:"back",onClick:v},"Return"),o.a.createElement(b.a,{key:"register",type:"primary",loading:m,onClick:function(){return h.handleSubmit()}},"Create virtual scene")],onCancel:v,destroyOnClose:!0},o.a.createElement("form",{onSubmit:h.handleSubmit},o.a.createElement(P,{label:"Description",name:"description",type:"text",placeholder:"Enter a description for this virtual scene",formik:h,theRef:g})))},le=n(514),de=function(){console.log("DJApp render");var e=m(),t=e.userInfo,n=e.isDJ,a=Object(r.useState)(!1),i=Object(s.a)(a,2),c=i[0],l=i[1],d=Object(r.useState)(null),u=Object(s.a)(d,2),g=u[0],p=u[1],h=se({server:"https://lummetry.appsvoice.com/janus"}),y=Object(s.a)(h,8),w=y[0],S=y[1],k=y[2],E=(y[3],y[4]),C=y[5];y[6],y[7];console.log("connection is: ",w);var j=Object(r.useCallback)((function(){var e=window.localStorage.currentRoomId;console.log("currentRoomIdString is: ",e);var t,n,r=window.localStorage.currentUserId;console.log("currentUserIdString is: ",e),r&&(t=Number(r)),e&&(n=Number(e)),console.log("UserID is: ",t),console.log("RoomID is: ",n),console.log("connection is: ",w),t&&n&&(console.log("Kicking user ".concat(t," from room ").concat(n)),U(w.api,n,t),window.localStorage.removeItem("currentRoomId"),window.localStorage.removeItem("currentUserId"))}),[w]);Object(r.useEffect)((function(){console.log("useEffect pentru connection: ",w),null!==w&&null!==w.api&&(console.log("We have api"),console.log("Will now refresh rooms:"),E())}),[w]),Object(r.useEffect)((function(){console.log("roomToJoin changed to: ",g)}),[g]);var O=function(){l(!0)},T=Object(r.useCallback)((function(e){console.log("We have joined the room: ",e),console.log("User id is ".concat(e.user_id," and room id is ").concat(e.user_room)),j(),window.localStorage.setItem("currentRoomId",e.user_room),window.localStorage.setItem("currentUserId",e.user_id);var t=Object(F.a)({},e);t.event="joined_room",console.log("isDJ: ",n),!1===n&&fetch("http://127.0.0.1:5500/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((function(e){return e.json()})).then((function(e){console.log("Jetson config got json: ",e)})).catch((function(e){console.log("Got error: ",e)}))}),[j,n]),D=Object(r.useCallback)((function(e){console.log("We have left the room: ",e),console.log("User id is ".concat(e.user_id)),window.localStorage.removeItem("currentUserId"),window.localStorage.removeItem("currentRoomId");var t=Object(F.a)({},e);t.event="left_room",console.log("isDJ: ",n),!1===n&&fetch("http://127.0.0.1:5500/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((function(e){return e.json()})).then((function(e){console.log("Jetson config got json: ",e)})).catch((function(e){console.log("Got error: ",e)})),p(null)}),[]);return w?o.a.createElement(o.a.Fragment,null,o.a.createElement(o.a.Fragment,null,null==g?o.a.createElement(o.a.Fragment,null,C.length>0?o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"flex flex-row justify-between py-6"},o.a.createElement("div",{className:"text-2xl"},"Hi ",t.username),!0===n&&o.a.createElement(b.a,{onClick:O},"Create virtual scene")),o.a.createElement("div",{className:"text-sm pb-4 "},!0===n?"Pick a virtual scene from the ones below or create your own virtual scene":"Click a virtual scene to join it"),o.a.createElement("div",{className:"videos-container -ml-2 rounded flex flex-row flex-wrap"},C.map((function(e,t){return r=e,o.a.createElement("div",{key:r.room,className:"xs:w-full w-1/3 flex-col p-2",style:{minWidth:"20rem"}},o.a.createElement("div",{style:{borderColor:"rgba(148, 153, 169, 0.32)",backgroundColor:"rgba(37, 49, 86, 0.48)"},className:"border border-transparent hover:border-purple-600 hover:bg-purple-800 rounded flex flex-col cursor-pointer p-4",onClick:function(){return p(r.room)}},o.a.createElement("div",{className:"flex flex-col"},o.a.createElement("div",{className:"w-full h-40 bg-center bg-cover bg-no-repeat rounded",style:{backgroundImage:"url(".concat(le,")")}}),o.a.createElement("div",{className:"font-semibold text-lg mx-auto py-2 text-gray-500"},r.description)),o.a.createElement("div",{className:"flex flex-row items-baseline mx-auto py-2"},o.a.createElement(b.a,{key:"join",onClick:function(){return p(r.room)}},"Join"),o.a.createElement("div",{className:"w-2"}),!0===n&&o.a.createElement(f.a,{placement:"bottomRight",key:"more",overlay:o.a.createElement(v.a,null,o.a.createElement(v.a.Item,{onClick:function(e){console.log("E is: ",e),k(r.room).then((function(e){E()}))}},"Delete virtual scene"))},o.a.createElement(b.a,null,o.a.createElement(M.a,{type:"ellipsis",style:{fontSize:20,verticalAlign:"top"}}))))));var r})))):o.a.createElement("div",{className:"text-center"},o.a.createElement("div",{className:"text-2xl p-6"},"Hi ",t.username),o.a.createElement(M.a,{type:"smile",className:"text-xl"}),!0===n?o.a.createElement(o.a.Fragment,null,o.a.createElement("p",{className:"p-6 text-lg"},"Create a virtual scene to get started"),o.a.createElement(b.a,{onClick:O},"Create virtual scene")):o.a.createElement("p",{className:"p-6 text-lg"},"No DJ rooms available at this moment. Waiting for a room to be created"))):o.a.createElement(oe,{connection:w,onRoomJoined:T,onRoomLeft:D,roomToJoin:g}),o.a.createElement(ce,{visibility:[c,l],createRoom:S,onSuccess:function(){E()}}))):null},ue=w.a.confirm,me=function(){var e=function(){var e=function(e){console.log("Got error: ",e),S.a.error({content:String(e),key:"registerError",duration:2})},t=m(),n=t.backendServer,o=t.authState,a=Object(r.useState)([]),i=Object(s.a)(a,2),c=i[0],l=i[1];return[c,Object(r.useCallback)((function(){fetch(n+"/users/list",{method:"GET",mode:"cors"}).then((function(e){return e.json()})).then((function(t){t.error?e(t.error):l(t)})).catch((function(t){e(t)}))}),[n]),Object(r.useCallback)((function(e){return new Promise((function(t,r){fetch(n+"/users/delete",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o.accessToken)},body:JSON.stringify({username:e})}).then((function(e){return e.json()})).then((function(e){e.error?r(e.error):t(e)})).catch((function(e){r(e)}))}))}),[n])]}(),t=Object(s.a)(e,3),n=t[0],a=t[1],i=t[2];Object(r.useEffect)((function(){return console.log("AdminApp constructor"),a(),function(){console.log("AdminApp destructor")}}),[]);var c=Object(r.useCallback)((function(e){console.log("Click pe "+e),ue({title:"Are you user you want to delete this user?",content:"".concat(e),onOk:function(){i(e).then((function(e){a()})).catch((function(e){S.a.error({content:String(e),key:"deleteUserError",duration:2})})),console.log("OK")},onCancel:function(){console.log("Cancel")}})}),[i,a]),l=Object(r.useCallback)((function(e,t,n){var r=t!==n.length-1;return o.a.createElement("div",{key:"user"+t,style:{borderColor:"#2e354a"},className:"w-full"},o.a.createElement("div",{className:"flex flex-row items-baseline py-1"},o.a.createElement("div",{className:"w-full grid grid-cols-5"},o.a.createElement("div",{className:"col-span-1"},e.username),o.a.createElement("div",{className:"col-span-1"},e.email),o.a.createElement("div",{className:"col-span-1"},e.firstName),o.a.createElement("div",{className:"col-span-1"},e.lastName),o.a.createElement("div",{className:"col-span-1"},o.a.createElement("div",{style:{borderColor:"#2e354a",backgroundColor:"#1e2948"},className:"rounded border hover:border-blue-800 transition duration-200 inline-block text-xs px-1"},e.accountType))),o.a.createElement("div",{className:"w-2"}),o.a.createElement(f.a,{placement:"bottomRight",key:"more",overlay:o.a.createElement(v.a,null,o.a.createElement(v.a.Item,{onClick:function(){return c(e.username)}},"Delete account"))},o.a.createElement(b.a,{style:{}},o.a.createElement(M.a,{type:"ellipsis",style:{fontSize:20,verticalAlign:"top"}})))),!0===r&&o.a.createElement("div",{style:{height:"1px",marginBottom:"-1px",backgroundColor:"#2e354a"}}))}),[]);return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"text-2xl py-6"},"Registered users"),n.length>0?o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{style:{borderColor:"#2e354a",backgroundColor:"#1e294873"},className:"users-table rounded-md px-2 py-1 border py"},o.a.createElement("div",{className:"flex flex-row items-baseline py-1"},o.a.createElement("div",{className:"w-full grid grid-cols-5 select-none"},o.a.createElement("div",{className:"col-span-1"},"Username"),o.a.createElement("div",{className:"col-span-1"},"Email"),o.a.createElement("div",{className:"col-span-1"},"First name"),o.a.createElement("div",{className:"col-span-1"},"Last name"),o.a.createElement("div",{className:"col-span-1"},"Account Type")),o.a.createElement("div",{className:"w-2"}),o.a.createElement("div",{style:{width:"3.2rem"}},"Action")),o.a.createElement("div",{style:{height:"1px",backgroundColor:"#2e354a"},className:"mb-2"}),n.map((function(e,t,n){return l(e,t,n)})))):null)},fe=(E.a.Option,function(e){var t=e.visibility,n=e.onProfileEditSuccess,a=Object(s.a)(t,2),i=a[0],c=a[1],l=Object(r.useState)(!1),d=Object(s.a)(l,2),u=d[0],f=d[1],g=m(),v=g.userInfo,h=(g.isDJ,g.backendServer),y=Object(r.useCallback)((function(e){fetch(h+"/users/edit",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e.username,email:e.email,firstName:e.firstName,lastName:e.lastName})}).then((function(e){return e.json()})).then((function(e){e.error?(O(e.error),f(!1)):(f(!1),c(!1),n(e))})).catch((function(e){O(e),f(!1)}))}),[h,n,c]),k=Object(C.a)({initialValues:{username:v.username,email:v.email,firstName:v.firstName,lastName:v.lastName},validationSchema:j.object({username:j.string().required("Please enter a username"),email:j.string().email("Please enter a valid email address").required("Plese enter an email address"),firstName:j.string().required("Please enter first name"),lastName:j.string().required("Please enter last name")}),onSubmit:function(e,t){t.setSubmitting;y(e)},validate:function(e){return{}}}),E=Object(r.useCallback)((function(){c(!1)}),[c]),O=function(e){console.log("Got error: ",e),S.a.error({content:String(e),key:"editError",duration:2})};return Object(r.useEffect)((function(){console.log("Visibility changed: ",i),!0===i&&k.resetForm()}),[i]),o.a.createElement(w.a,{title:"Edit your profile",visible:i,onOk:function(){k.handleSubmit()},onCancel:E,footer:[o.a.createElement(b.a,{key:"back",onClick:E},"Return"),o.a.createElement(b.a,{key:"saveuser",type:"primary",loading:u,onClick:function(){return k.handleSubmit()}},"Save")],destroyOnClose:!0},o.a.createElement(p.a,null,o.a.createElement("form",{onSubmit:k.handleSubmit},o.a.createElement(P,{label:"Username",name:"username",type:"text",placeholder:"Enter a username",formik:k}),o.a.createElement(P,{label:"E-mail",name:"email",type:"email",placeholder:"Enter your e-mail",formik:k}),o.a.createElement(P,{label:"First name",name:"firstName",type:"text",placeholder:"Enter first name",formik:k}),o.a.createElement(P,{label:"Last name",name:"lastName",type:"text",placeholder:"Enter last name",formik:k}))))}),ge=function(){var e=m(),t=e.userInfo,a=e.doLogin,i=e.doLogout,c=e.isAdmin,l=Object(r.useState)(!1),d=Object(s.a)(l,2),u=d[0],p=d[1],b=Object(r.useState)(!1),h=Object(s.a)(b,2),y=h[0],w=h[1],S=Object(r.useCallback)((function(e){"logout"===e.key&&(p(!1),i()),"profile"===e.key&&(p(!1),w(!0))}),[]),k=o.a.createElement(v.a,{onClick:S},o.a.createElement(v.a.Item,{key:"profile"},"Profile"),o.a.createElement(v.a.Item,{key:"logout"},"Logout")),E=n(237);return t?o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx-auto px-20 "},o.a.createElement("div",{className:"flex flex-col h-full"},o.a.createElement("div",{className:"flex-initial"},o.a.createElement("div",{className:"flex flex-row justify-between items-baseline py-4"},o.a.createElement("div",{className:"w-20 h-5 bg-contain bg-no-repeat bg-center",style:{backgroundImage:"url(".concat(E,")")}}),o.a.createElement(f.a,{placement:"bottomRight",visible:u,overlay:k,onVisibleChange:function(e){return p(e)}},o.a.createElement("div",{className:"flex flex-row items-center select-none cursor-pointer"},o.a.createElement("div",{className:"font-medium mr-2"},t.username),o.a.createElement(g.a,{style:{backgroundColor:"#87d068"},icon:"user"})))),o.a.createElement("div",{style:{height:"1px",backgroundColor:"#444c67"}})),o.a.createElement("div",{className:"flex-auto overflow-auto relative"},!1===c?o.a.createElement(de,null):o.a.createElement(me,null)))),o.a.createElement(fe,{visibility:[y,w],onProfileEditSuccess:function(){console.log("onProfileEditSuccess")}})):o.a.createElement(V,{onLogin:a})},ve="".concat(document.location.origin,"/api/");n(515);i.a.render(o.a.createElement((function(){var e=l(),t=Object(s.a)(e,3),n=t[0],a=t[1],i=t[2],c=Object(r.useState)(ve),d=Object(s.a)(c,2),m=d[0],f=d[1];console.log("Backend server is: "+m),console.log("userInfo is: ",n.userInfo);var g=!(!n.userInfo||"dj"!==n.userInfo.accountType),v=!(!n.userInfo||"admin"!==n.userInfo.accountType),p={authState:n,doLogin:a,doLogout:i,userInfo:n.userInfo,isDJ:g,isAdmin:v,backendServer:m,setBackendServer:f};return o.a.createElement(u,{state:p},o.a.createElement(ge,null))}),null),document.getElementById("root"))}},[[263,1,2]]]);
//# sourceMappingURL=main.50dd9c72.chunk.js.map